<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universite Djibo Hamani - D√©p√¥t de Dossiers en Ligne</title>
    
   
<link rel="stylesheet" href="Style.css">
<link rel="stylesheet" href="Style.css">
<style>

/* Styles sp√©cifiques pour les statistiques */
.stats-tab-content {
    display: none;
    animation: fadeIn 0.3s ease-in-out;
}

.stats-tab-content.active {
    display: block;
}

.tab-btn {
    padding: 12px 20px;
    border: none;
    background: #f8f9fa;
    color: #666;
    border-radius: 25px 25px 0 0;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    border-bottom: 3px solid transparent;
}

.tab-btn.active {
    background: #667eea;
    color: white;
    border-bottom-color: #667eea;
}

.tab-btn:hover:not(.active) {
    background: #e9ecef;
    color: #667eea;
}

/* Am√©liorations des cartes de statistiques */
.dashboard-card h3 {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 20px;
    color: #333;
    font-size: 16px;
    font-weight: 600;
    padding-bottom: 10px;
    border-bottom: 2px solid #f1f3f4;
}

/* Styles pour les d√©tails des statistiques */
.stat-detail {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin: 10px 0;
    border-left: 4px solid #667eea;
}

.stat-detail h4 {
    margin: 0 0 10px 0;
    color: #667eea;
    font-size: 18px;
}

.stat-detail p {
    margin: 5px 0;
    color: #666;
}

/* Animation pour les changements d'onglets */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.stats-tab-content.active {
    animation: slideIn 0.4s ease-out;
}

/* Responsive design pour les onglets */
@media (max-width: 768px) {
    .tabs {
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .tab-btn {
        font-size: 12px;
        padding: 8px 12px;
    }
    
    .dashboard-grid {
        grid-template-columns: 1fr !important;
    }
}

/* Styles pour les tooltips des graphiques */
.chart-tooltip {
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    pointer-events: none;
}

/* Loading states */
.loading-chart {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 300px;
    color: #666;
    font-style: italic;
}

.loading-chart::before {
    content: "üìä";
    font-size: 48px;
    margin-right: 10px;
    animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
}
</style>
<script>
// CORRECTION PRINCIPALE - Ajouter ces fonctions au d√©but de votre script

// Fonction pour s'assurer que Chart.js est charg√©
function waitForChartJS(callback) {
    if (typeof Chart !== 'undefined') {
        callback();
    } else {
        console.log('En attente de Chart.js...');
        setTimeout(() => waitForChartJS(callback), 500);
    }
}

// Initialisation des statistiques corrig√©e
function initialiserStatistiques() {
    console.log('Initialisation du module statistiques');
    
    waitForChartJS(() => {
        console.log('Chart.js disponible, configuration...');
        
        // Configuration globale de Chart.js
        Chart.defaults.font.family = 'Arial, sans-serif';
        Chart.defaults.color = '#666';
        Chart.defaults.plugins.legend.labels.padding = 15;
        
        console.log('Module statistiques initialis√© avec succ√®s');
    });
}

// Fonction de d√©bogage pour v√©rifier les √©l√©ments
function verifierElementsStats() {
    const elements = [
        'statTotalCandidatures',
        'statApprouvees', 
        'statHommes',
        'statFemmes',
        'chartTopFilieres',
        'chartRepartitionBac',
        'chartEvolution',
        'chartGenre'
    ];
    
    console.log('=== V√âRIFICATION DES √âL√âMENTS STATISTIQUES ===');
    elements.forEach(id => {
        const element = document.getElementById(id);
        console.log(`${id}:`, element ? 'TROUV√â' : 'MANQUANT');
    });
    console.log('=== FIN V√âRIFICATION ===');
}

// Fonction de test pour v√©rifier ApiClient
function testerApiClient() {
    console.log('=== TEST APICLIENT ===');
    console.log('ApiClient d√©fini:', typeof apiClient !== 'undefined');
    console.log('Token pr√©sent:', apiClient?.token ? 'OUI' : 'NON');
    console.log('M√©thodes stats disponibles:');
    console.log('- getStatsDashboard:', typeof apiClient?.getStatsDashboard === 'function');
    console.log('- getStatsByGenre:', typeof apiClient?.getStatsByGenre === 'function');
    console.log('=== FIN TEST ===');
}

// Fonction de test compl√®te des statistiques
async function testerStatistiques() {
    console.log('üîç D√âBUT TEST COMPLET STATISTIQUES');
    
    try {
        // 1. V√©rifier les √©l√©ments HTML
        verifierElementsStats();
        
        // 2. V√©rifier ApiClient
        testerApiClient();
        
        // 3. Test d'une requ√™te simple
        if (typeof apiClient !== 'undefined' && apiClient.token) {
            console.log('üìä Test requ√™te dashboard...');
            const response = await apiClient.getStatsDashboard();
            console.log('‚úÖ R√©ponse re√ßue:', response);
        } else {
            console.log('‚ö†Ô∏è Impossible de tester - ApiClient non pr√™t');
        }
        
    } catch (error) {
        console.error('‚ùå Erreur test:', error);
    }
    
    console.log('üèÅ FIN TEST STATISTIQUES');
}

// AJOUTER CES FONCTIONS DE DIAGNOSTIC
window.debugStats = {
    verifierElements: verifierElementsStats,
    testerApi: testerApiClient,
    testerComplete: testerStatistiques,
    chargerDashboard: () => {
        if (typeof chargerTableauBordStats !== 'undefined') {
            chargerTableauBordStats();
        } else {
            console.error('Fonction chargerTableauBordStats non trouv√©e');
        }
    }
};

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initialisation page...');
    
    setTimeout(() => {
        initialiserStatistiques();
        
        // Test automatique si en mode admin
        if (localStorage.getItem('userRole') === 'admin') {
            console.log('üëë Mode admin d√©tect√© - test des statistiques');
            setTimeout(testerStatistiques, 3000);
        }
    }, 1000);
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
window.addEventListener('DOMContentLoaded', function() {
    if (typeof window.jspdf !== 'undefined' && window.jspdf.jsPDF) {
        window.jsPDF = window.jspdf.jsPDF;
        console.log('‚úÖ jsPDF charg√© avec succ√®s');
    } else {
        console.error('‚ùå Erreur de chargement de jsPDF');
    }
});
</script>
</head>
<body>
    <div class="container">
    <header class="header">
        <div class="logo-section">
            <img src="/uploads/logo-universite.png" alt="Logo Universit√©" class="logo-image" onerror="this.style.display='none'">
            <div class="logo-text">Universit√© Djibo Hamani de Tahoua</div>
        </div>
        <nav class="nav-buttons">
            <button class="btn btn-secondary" onclick="showPage('accueil')" id="homeBtn">Accueil</button>
            <button class="btn btn-secondary" onclick="showPage('connexion')" id="loginBtn">Connexion</button>
            <button class="btn btn-primary" id="registerBtn">
                <a href="inscription.html" style="color: white; text-decoration: none;">Inscription</a>
            </button>
            <button class="btn btn-primary" onclick="showPage('inscription')" id="registerBtn">Pre_Inscription</button>
            <button class="btn btn-secondary" onclick="logout()" id="logoutBtn" style="display: none;">D√©connexion</button>
        </nav>
    </header>
</div>


        <main class="main-content">
            <!-- Page d'accueil -->
            <div id="accueil" class="page active">
                <h1 style="text-align: center; margin-bottom: 30px; color: #333;">Bienvenue √† L'Universit√© Djibo Hamani de Tahoua</h1>
                <p style="text-align: center; font-size: 18px; margin-bottom: 40px; color: #666;">
                    Plateforme moderne de d√©p√¥t de dossiers en ligne pour les √©tablissements d'enseignement
                </p>
                
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-icon">üìã</div>
                        <div class="card-title">Processus Simplifi√©</div>
                        <div class="card-description">
                            D√©posez votre dossier en 4 √©tapes simples : informations personnelles, choix de fili√®re, documents et validation.
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-icon">üîí</div>
                        <div class="card-title">S√©curis√©</div>
                        <div class="card-description">
                            Vos donn√©es sont prot√©g√©es par des syst√®mes de s√©curit√© avanc√©s et un chiffrement de bout en bout.
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-icon">‚ö°</div>
                        <div class="card-title">Rapide</div>
                        <div class="card-description">
                            Suivi en temps r√©el de votre dossier avec notifications automatiques et t√©l√©chargement du quitus.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page d'inscription -->
            <div id="inscription" class="page">
                <h2 style="text-align: center; margin-bottom: 30px;">Cr√©er un compte</h2>
                
                <form id="registerForm" onsubmit="register(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="regNom">Nom complet *</label>
                            <input type="text" id="regNom" required>
                        </div>
                        <div class="form-group">
                            <label for="regEmail">Email *</label>
                            <input type="email" id="regEmail" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="regTelephone">Num√©ro de t√©l√©phone *</label>
                            <input type="tel" id="regTelephone" required>
                        </div>
                        <div class="form-group">
                            <label for="regDateNaissance">Date de naissance</label>
                            <input type="date" id="regDateNaissance">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="regMotDePasse">Mot de passe *</label>
                        <input type="password" id="regMotDePasse" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="regConfirmMotDePasse">Confirmer le mot de passe *</label>
                        <input type="password" id="regConfirmMotDePasse" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">Cr√©er mon compte</button>
                </form>
            </div>

            <!-- Page de connexion -->
            <div id="connexion" class="page">
                <h2 style="text-align: center; margin-bottom: 30px;">Se connecter</h2>
                
                <form id="loginForm" onsubmit="login(event)">
                    <div class="form-group">
                        <label for="loginIdentifiant">Email ou T√©l√©phone *</label>
                        <input type="text" id="loginIdentifiant" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="loginMotDePasse">Mot de passe *</label>
                        <input type="password" id="loginMotDePasse" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">Se connecter</button>
                    
                    <p style="text-align: center; margin-top: 20px;">
                        <a href="#" onclick="showPage('inscription')" style="color: #667eea; text-decoration: none;">Pas encore de compte ? S'inscrire</a>
                    </p>
                </form>
            </div>

            <!-- Tableau de bord utilisateur -->
            <div id="dashboard" class="page">
                <h2 style="margin-bottom: 30px;">Tableau de bord</h2>
                
                <div class="dashboard-grid">
                    <div class="dashboard-card" onclick="startApplicationProcess()">
                        <div class="card-icon">üì§</div>
                        <div class="card-title">Nouveau d√©p√¥t</div>
                        <div class="card-description">
                            Commencer un nouveau d√©p√¥t de dossier en suivant le processus guid√©.
                        </div>
                    </div>
                    <div class="dashboard-card" onclick="showPage('mesDossiers')">
                        <div class="card-icon">üìÅ</div>
                        <div class="card-title">Mes dossiers</div>
                        <div class="card-description">
                            Consulter l'√©tat de vos dossiers d√©pos√©s et t√©l√©charger les documents.
                        </div>
                    </div>
                    <div class="dashboard-card" onclick="showPage('profil')">
                        <div class="card-icon">üë§</div>
                        <div class="card-title">Mon profil</div>
                        <div class="card-description">
                            Modifier vos informations personnelles et param√®tres de compte.
                        </div>
                    </div>
                </div>

                <div style="margin-top: 40px;">
                    <h3>Derni√®res activit√©s</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 15px;">
                        <p>Aucune activit√© r√©cente</p>
                    </div>
                </div>
            </div>

            <!-- Processus de d√©p√¥t - √âtape 1 -->
            <div id="etape1" class="page">
                <div class="step-indicator">
                    <div class="step active">
                        <div class="step-number">1</div>
                        <span>Informations personnelles</span>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <span>Choix de fili√®re</span>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <span>Documents</span>
                    </div>
                    <div class="step">
                        <div class="step-number">4</div>
                        <span>R√©sum√©</span>
                    </div>
                </div>

                <h2 style="margin-bottom: 30px;">√âtape 1 : Informations personnelles</h2>
                
                <form id="etape1Form" onsubmit="nextStep(event, 2)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nom">Nom *</label>
                            <input type="text" id="nom" required>
                        </div>
                        <div class="form-group">
                            <label for="prenom">Pr√©nom *</label>
                            <input type="text" id="prenom" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dateNaissance">Date de naissance *</label>
                            <input type="date" id="dateNaissance" required>
                        </div>
                        <div class="form-group">
                            <label for="lieuNaissance">Lieu de naissance *</label>
                            <input type="text" id="lieuNaissance" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nationalite">Nationalit√© *</label>
                            <select id="nationalite" required>
                                <option value="">S√©lectionner...</option>
                                <option value="nigerienne">Nig√©rienne</option>
                                <option value="francaise">Fran√ßaise</option>
                                <option value="autre">Autre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="genre">Genre *</label>
                            <select id="genre" required>
                                <option value="">S√©lectionner...</option>
                                <option value="masculin">Masculin</option>
                                <option value="feminin">F√©minin</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
    <div class="form-group">
        <label for="typeBac">Type de Bac * <small>(Filtre les fili√®res disponibles)</small></label>
        <select id="typeBac" required>
            <option value="">Chargement des types de bac...</option>
        </select>
        <div class="form-hint">
            <small>‚ÑπÔ∏è S√©lectionnez votre type de bac pour voir les fili√®res compatibles √† l'√©tape suivante</small>
        </div>
    </div>
    <div class="form-group">
        <label for="lieuObtention">Lieu d'obtention *</label>
        <select id="lieuObtention" required>
            <option value="">S√©lectionner...</option>
            <option value="Dosso">Dosso</option>
            <option value="Niamey">Niamey</option>
            <option value="Tahoua">Tahoua</option>
            <option value="Agadez">Agadez</option>
            <option value="Maradi">Maradi</option>
            <option value="Tillab√©ri">Tillab√©ri</option>
            <option value="Zinder">Zinder</option>
            <option value="Diffa">Diffa</option>
        </select>
    </div>
</div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="anneeObtention">Ann√©e d'Obtention *</label>
                            <select id="anneeObtention" required>
                                <option value="">S√©lectionner...</option>
                                <option value="2024-2025">2024-2025</option>
                                <option value="2025-2026">2025-2026</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="mention">Mention *</label>
                            <select id="mention" required>
                                <option value="">S√©lectionner...</option>
                                <option value="Passable">Passable</option>
                                <option value="Bien">Bien</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="adresse">Adresse compl√®te *</label>
                        <textarea id="adresse" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="telephone">T√©l√©phone *</label>
                            <input type="tel" id="telephone" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" required>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 30px;">√âtape suivante</button>
                </form>
            </div>

            <!-- Processus de d√©p√¥t - √âtape 2 -->
            <div class="page" id="etape2">
    <div class="step-indicator">
        <div class="step completed">
            <div class="step-number">1</div>
            <span>Informations personnelles</span>
        </div>
        <div class="step active">
            <div class="step-number">2</div>
            <span>Choix de fili√®re</span>
        </div>
        <div class="step">
            <div class="step-number">3</div>
            <span>Documents</span>
        </div>
        <div class="step">
            <div class="step-number">4</div>
            <span>R√©sum√©</span>
        </div>
    </div>

    <h2 style="margin-bottom: 30px;">√âtape 2 : Choix de fili√®re</h2>
    
    <!-- Rappel du type de bac s√©lectionn√© -->
    <div id="rappelTypeBac" style="background: #e8f4ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;">
        <h4 style="margin: 0 0 10px 0; color: #667eea;">üìö Type de bac s√©lectionn√©</h4>
        <p id="typeBacSelectionne" style="margin: 0; font-weight: 600;">-</p>
        <small style="color: #666;">Les fili√®res ci-dessous sont compatibles avec votre type de bac</small>
    </div>
    
    <form id="etape2Form" onsubmit="nextStep(event, 3)">
        <div class="form-group">
            <label for="premierChoix">Premier choix * <span style="color: #28a745; font-weight: bold;">(Priorit√© 1)</span></label>
            <select id="premierChoix" required>
                <option value="">Chargement des fili√®res compatibles...</option>
            </select>
            <div class="form-hint">
                <small>üí° Votre choix principal - privil√©gi√© lors de l'affectation</small>
            </div>
        </div>
        
        <div class="form-group">
            <label for="deuxiemeChoix">Deuxi√®me choix * <span style="color: #ffc107; font-weight: bold;">(Priorit√© 2)</span></label>
            <select id="deuxiemeChoix" required>
                <option value="">S√©lectionner d'abord le premier choix</option>
            </select>
            <div class="form-hint">
                <small>üîÑ Choix de secours en cas de non-acceptation du premier</small>
            </div>
        </div>
        
        <div class="form-group">
            <label for="troisiemeChoix">Troisi√®me choix * <span style="color: #dc3545; font-weight: bold;">(Priorit√© 3)</span></label>
            <select id="troisiemeChoix" required>
                <option value="">S√©lectionner d'abord les deux premiers choix</option>
            </select>
            <div class="form-hint">
                <small>üéØ Dernier choix de s√©curit√©</small>
            </div>
        </div>
        
        <!-- Aide contextuelle -->
        <div class="info-box" style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 20px 0;">
            <h5 style="margin: 0 0 10px 0; color: #856404;">üìã Conseils pour vos choix</h5>
            <ul style="margin: 0; padding-left: 20px; color: #856404;">
                <li>Classez vos choix par ordre de pr√©f√©rence r√©elle</li>
                <li>V√©rifiez les capacit√©s d'accueil de chaque fili√®re</li>
                <li>Assurez-vous que les trois fili√®res sont diff√©rentes</li>
                <li>Consultez les d√©bouch√©s professionnels avant de choisir</li>
            </ul>
        </div>
        
        <!-- Informations sur les fili√®res -->
        <div id="infosFilieresChoisies" style="margin-top: 20px;">
            <!-- Les informations des fili√®res choisies appara√Ætront ici -->
        </div>
        
        <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button type="button" class="btn btn-secondary" onclick="showPage('etape1')">Pr√©c√©dent</button>
            <button type="submit" class="btn btn-primary" style="flex: 1;">√âtape suivante</button>
        </div>
    </form>
</div>



            <!-- Processus de d√©p√¥t - √âtape 3 -->
            <div id="etape3" class="page">
                <div class="step-indicator">
                    <div class="step completed">
                        <div class="step-number">1</div>
                        <span>Informations personnelles</span>
                    </div>
                    <div class="step completed">
                        <div class="step-number">2</div>
                        <span>Choix de fili√®re</span>
                    </div>
                    <div class="step active">
                        <div class="step-number">3</div>
                        <span>Documents</span>
                    </div>
                    <div class="step">
                        <div class="step-number">4</div>
                        <span>R√©sum√©</span>
                    </div>
                </div>

                <h2 style="margin-bottom: 30px;">√âtape 3 : Documents requis</h2>
                
                <form id="etape3Form" onsubmit="nextStep(event, 4)">
                    <!-- Remplacer la section des documents dans l'√©tape 3 -->
<div class="form-group">
    <label>Photo d'identit√© *</label>
    <div class="file-upload" onclick="document.getElementById('photoIdentite').click()">
        <div class="file-upload-icon">üì∑</div>
        <p>Cliquez pour t√©l√©charger votre photo d'identit√©</p>
        <p style="font-size: 12px; color: #666;">Format JPG, PNG - Max 2MB</p>
    </div>
    <input type="file" id="photoIdentite" style="display: none;" accept="image/*" required onchange="afficherApercuDocument('photoIdentite', this)">
    <div id="apercu-photoIdentite" class="file-preview" style="display: none;"></div>
</div>

<div class="form-group">
    <label>Pi√®ce d'identit√© (recto-verso) *</label>
    <div class="file-upload" onclick="document.getElementById('pieceIdentite').click()">
        <div class="file-upload-icon">üÜî</div>
        <p>T√©l√©charger votre pi√®ce d'identit√©</p>
        <p style="font-size: 12px; color: #666;">Format PDF, JPG, PNG - Max 5MB</p>
    </div>
    <input type="file" id="pieceIdentite" style="display: none;" accept="image/*,application/pdf" required onchange="afficherApercuDocument('pieceIdentite', this)">
    <div id="apercu-pieceIdentite" class="file-preview" style="display: none;"></div>
</div>

<div class="form-group">
    <label>Dipl√¥me de baccalaur√©at *</label>
    <div class="file-upload" onclick="document.getElementById('diplomeBac').click()">
        <div class="file-upload-icon">üéì</div>
        <p>T√©l√©charger votre dipl√¥me de baccalaur√©at</p>
        <p style="font-size: 12px; color: #666;">Format PDF, JPG, PNG - Max 5MB</p>
    </div>
    <input type="file" id="diplomeBac" style="display: none;" accept="image/*,application/pdf" required onchange="afficherApercuDocument('diplomeBac', this)">
    <div id="apercu-diplomeBac" class="file-preview" style="display: none;"></div>
</div>

<div class="form-group">
    <label>Relev√© de notes du baccalaur√©at *</label>
    <div class="file-upload" onclick="document.getElementById('releve').click()">
        <div class="file-upload-icon">üìä</div>
        <p>T√©l√©charger votre relev√© de notes</p>
        <p style="font-size: 12px; color: #666;">Format PDF, JPG, PNG - Max 5MB</p>
    </div>
    <input type="file" id="releve" style="display: none;" accept="image/*,application/pdf" required onchange="afficherApercuDocument('releve', this)">
    <div id="apercu-releve" class="file-preview" style="display: none;"></div>
</div>

<div class="form-group">
    <label>Certificat de nationalit√©</label>
    <div class="file-upload" onclick="document.getElementById('certificatNationalite').click()">
        <div class="file-upload-icon">üåç</div>
        <p>T√©l√©charger votre certificat de nationalit√© (optionnel)</p>
        <p style="font-size: 12px; color: #666;">Format PDF, JPG, PNG - Max 5MB</p>
    </div>
    <input type="file" id="certificatNationalite" style="display: none;" accept="image/*,application/pdf" onchange="afficherApercuDocument('certificatNationalite', this)">
    <div id="apercu-certificatNationalite" class="file-preview" style="display: none;"></div>
</div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button type="button" class="btn btn-secondary" onclick="showPage('etape2')">Pr√©c√©dent</button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">√âtape suivante</button>
                    </div>
                </form>
            </div>

            <!-- Processus de d√©p√¥t - √âtape 4 -->
            <div id="etape4" class="page">
                <div class="step-indicator">
                    <div class="step completed">
                        <div class="step-number">1</div>
                        <span>Informations personnelles</span>
                    </div>
                    <div class="step completed">
                        <div class="step-number">2</div>
                        <span>Choix de fili√®re</span>
                    </div>
                    <div class="step completed">
                        <div class="step-number">3</div>
                        <span>Documents</span>
                    </div>
                    <div class="step active">
                        <div class="step-number">4</div>
                        <span>R√©sum√©</span>
                    </div>
                </div>

                <h2 style="margin-bottom: 30px;">√âtape 4 : R√©sum√© et validation</h2>
                
                <!-- Remplacer la section r√©sum√© dans l'√©tape 4 -->
<div style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 30px;">
    <h3 style="color: #667eea; margin-bottom: 20px;">üìã R√©sum√© complet de votre dossier</h3>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
            <h4 style="color: #333; margin-bottom: 10px;">üë§ Informations personnelles</h4>
            <div style="background: white; padding: 15px; border-radius: 8px;">
                <p id="resumeNomPrenom" style="margin: 5px 0; font-weight: 600;"></p>
                <p id="resumeNaissance" style="margin: 5px 0;"></p>
                <p id="resumeContact" style="margin: 5px 0;"></p>
                <p style="margin: 5px 0;"><strong>Nationalit√©:</strong> <span id="resumeNationalite"></span></p>
                <p style="margin: 5px 0;"><strong>Genre:</strong> <span id="resumeGenre"></span></p>
                <p style="margin: 5px 0;"><strong>Adresse:</strong> <span id="resumeAdresse"></span></p>
            </div>
        </div>
        
        <div>
            <h4 style="color: #333; margin-bottom: 10px;">üéì Informations baccalaur√©at</h4>
            <div style="background: white; padding: 15px; border-radius: 8px;" id="resumeBac">
                <!-- Rempli dynamiquement -->
            </div>
        </div>
    </div>
    
    <div style="margin-top: 20px;">
        <h4 style="color: #333; margin-bottom: 10px;">üìö Choix de formation</h4>
        <div style="background: white; padding: 15px; border-radius: 8px;" id="resumeFormation">
            <!-- Rempli dynamiquement -->
        </div>
    </div>
    
    <div style="margin-top: 20px;">
        <h4 style="color: #333; margin-bottom: 10px;">üìé Documents fournis</h4>
        <div id="listeDocuments" style="background: white; padding: 15px; border-radius: 8px;">
            <!-- Rempli dynamiquement -->
        </div>
    </div>
</div>
                
                <div style="background: #e8f4ff; padding: 20px; border-radius: 10px; border-left: 4px solid #667eea; margin-bottom: 30px;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">‚ÑπÔ∏è Information importante</h4>
                    <p>Veuillez v√©rifier attentivement toutes les informations avant de valider votre dossier. Une fois valid√©, vous recevrez un quitus que vous pourrez t√©l√©charger.</p>
                </div>
                
                <form id="etape4Form" onsubmit="submitApplication(event)">
                    <div style="display: flex; align-items: center; margin-bottom: 30px;">
                        <input type="checkbox" id="confirmationDonnees" required style="margin-right: 10px; transform: scale(1.5);">
                        <label for="confirmationDonnees" style="cursor: pointer;">
                            Je certifie que toutes les informations fournies sont exactes et compl√®tes
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 15px;">
                        <button type="button" class="btn btn-secondary" onclick="showPage('etape3')">Pr√©c√©dent</button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">‚úÖ Valider mon dossier</button>
                    </div>
                </form>
            </div>

            <!-- Page Mes dossiers -->
            <div id="mesDossiers" class="page">
                <h2 style="margin-bottom: 30px;">Mes dossiers</h2>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date de d√©p√¥t</th>
                            <th>Nom et Prenom</th>
                            <th>Numero dossier</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableauDossiers">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 40px; color: #666;">
                                Aucun dossier d√©pos√© pour le moment
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Page Profil -->
            <div id="profil" class="page">
                <h2 style="margin-bottom: 30px;">Mon profil</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h3 style="margin-bottom: 20px; color: #667eea;">Informations personnelles</h3>
                        <form id="profilForm" onsubmit="updateProfile(event)">
                            <div class="form-group">
                                <label for="profilNom">Nom complet</label>
                                <input type="text" id="profilNom" required>
                            </div>
                            <div class="form-group">
                                <label for="profilEmail">Email</label>
                                <input type="email" id="profilEmail" required>
                            </div>
                            <div class="form-group">
                                <label for="profilTelephone">T√©l√©phone</label>
                                <input type="tel" id="profilTelephone" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Mettre √† jour</button>
                        </form>
                    </div>
                    
                    <div>
                        <h3 style="margin-bottom: 20px; color: #667eea;">Changer le mot de passe</h3>
                        <form id="motDePasseForm" onsubmit="changePassword(event)">
                            <div class="form-group">
                                <label for="ancienMotDePasse">Ancien mot de passe</label>
                                <input type="password" id="ancienMotDePasse" required>
                            </div>
                            <div class="form-group">
                                <label for="nouveauMotDePasse">Nouveau mot de passe</label>
                                <input type="password" id="nouveauMotDePasse" required>
                            </div>
                            <div class="form-group">
                                <label for="confirmNouveauMotDePasse">Confirmer le nouveau mot de passe</label>
                                <input type="password" id="confirmNouveauMotDePasse" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Changer le mot de passe</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Panel Admin -->
            <div id="adminPanel" class="page">
                <h2 style="margin-bottom: 30px;">Panel Administrateur</h2>
                
                <div class="dashboard-grid" style="margin-bottom: 40px;">
                    <div class="dashboard-card" onclick="showAdminSection('gestionUtilisateurs')">
                        <div class="card-icon">üë•</div>
                        <div class="card-title">Gestion des utilisateurs</div>
                        <div class="card-description">
                            Voir, modifier, approuver ou supprimer les comptes utilisateurs
                        </div>
                    </div>
                    <div class="dashboard-card" onclick="showAdminSection('gestionDossiers')">
                        <div class="card-icon">üìÅ</div>
                        <div class="card-title">Gestion des dossiers</div>
                        <div class="card-description">
                            Examiner, approuver ou rejeter les dossiers d√©pos√©s
                        </div>
                    </div>
                    <div class="dashboard-card" onclick="showAdminSection('statistiques')">
                        <div class="card-icon">üìä</div>
                        <div class="card-title">Statistiques</div>
                        <div class="card-description">
                            Voir les statistiques d√©taill√©es des d√©p√¥ts et utilisateurs
                        </div>
                    </div>
                    <div class="dashboard-card" onclick="showAdminSection('gestionFormations')">
                        <div class="card-icon">üè´</div>
                        <div class="card-title">Gestion des Formations</div>
                        <div class="card-description">
                            G√©rer les facult√©s, fili√®res et types de bac
                        </div>
                    </div>
                    <div class="dashboard-card" onclick="showAdminSection('importExport')">
                        <div class="card-icon">üì§</div>
                        <div class="card-title">Import/Export</div>
                        <div class="card-description">
                            Importer et exporter les donn√©es en diff√©rents formats
                        </div>
                    </div>
                    <div class="dashboard-card" onclick="showAdminSection('gestionInscriptions')">
    <div class="card-icon">üìù</div>
    <div class="card-title">Inscriptions en Ligne</div>
    <div class="card-description">
        G√©rer les inscriptions des √©tudiants, autoriser/bloquer, configurer
    </div>
</div>
                </div>
            </div>
    <div id="gestionInscriptions" class="page">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2>Gestion des Inscriptions en Ligne</h2>
        <button class="btn btn-secondary" onclick="showPage('adminPanel')">‚¨ÖÔ∏è Retour</button>
    </div>

    <!-- Statistiques rapides -->
    <div class="dashboard-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 30px;">
        <div class="dashboard-card">
            <div class="card-icon">üë•</div>
            <div class="card-title">Total √âtudiants</div>
            <div style="font-size: 28px; font-weight: bold;" id="statTotalEtudiants">0</div>
        </div>
        <div class="dashboard-card">
            <div class="card-icon">‚úÖ</div>
            <div class="card-title">Autoris√©s</div>
            <div style="font-size: 28px; font-weight: bold; color: #28a745;" id="statAutorises">0</div>
        </div>
        <div class="dashboard-card">
            <div class="card-icon">üÜï</div>
            <div class="card-title">Nouveaux</div>
            <div style="font-size: 28px; font-weight: bold;" id="statNouveaux">0</div>
        </div>
        <div class="dashboard-card">
            <div class="card-icon">üéì</div>
            <div class="card-title">Anciens</div>
            <div style="font-size: 28px; font-weight: bold;" id="statAnciens">0</div>
        </div>
    </div>

    <!-- Configuration globale -->
    <div class="dashboard-card" style="margin-bottom: 30px;">
        <h3>‚öôÔ∏è Configuration Globale</h3>
        <form id="configAutorisationsForm" onsubmit="configurerAutorisations(event)">
            <div class="form-row">
                <div class="form-group">
                    <label for="typeAutorisation">Type d'autorisation *</label>
                    <select id="typeAutorisation" onchange="toggleAutorisationFields()">
                        <option value="tous">Tous les √©tudiants</option>
                        <option value="nouveaux">Nouveaux √©tudiants uniquement</option>
                        <option value="anciens">Anciens √©tudiants uniquement</option>
                        <option value="filiere">Par fili√®re</option>
                        <option value="niveau">Par niveau</option>
                    </select>
                </div>
            </div>
            
            <div id="filieresField" class="form-group" style="display: none;">
                <label>Fili√®res autoris√©es</label>
                <div id="filieresCheckboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 8px; padding: 10px;"></div>
            </div>
            
            <div id="niveauxField" class="form-group" style="display: none;">
                <label>Niveaux autoris√©s</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <label><input type="checkbox" name="niveau" value="L1"> L1</label>
                    <label><input type="checkbox" name="niveau" value="L2"> L2</label>
                    <label><input type="checkbox" name="niveau" value="L3"> L3</label>
                    <label><input type="checkbox" name="niveau" value="M1"> M1</label>
                    <label><input type="checkbox" name="niveau" value="M2"> M2</label>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">üíæ Enregistrer la configuration</button>
        </form>
    </div>

    <!-- Actions rapides -->
    <div class="dashboard-card" style="margin-bottom: 30px;">
        <h3>‚ö° Actions Rapides</h3>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
            <button class="btn btn-success" onclick="autoriserTous()">‚úÖ Autoriser tous</button>
            <button class="btn btn-warning" onclick="bloquerTous()">üö´ Bloquer tous</button>
            <button class="btn btn-primary" onclick="exporterEtudiants()">üìä Exporter liste</button>
        </div>
    </div>
   <!-- Dans la div gestionInscriptions, ajouter apr√®s les actions rapides -->

<div class="dashboard-card" style="margin-bottom: 30px;">
    <h3>üì§ Import & Export</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <!-- Import -->
        <div style="background: #e8f4ff; padding: 20px; border-radius: 10px;">
            <h4 style="margin-bottom: 15px;">üì• Importer √âtudiants Autoris√©s</h4>
            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                Importez un fichier Excel pour autoriser/bloquer des √©tudiants en masse
            </p>
            <div style="display: flex; gap: 10px; flex-direction: column;">
                <button class="btn btn-primary" onclick="telechargerModeleImport()">
                    üìã T√©l√©charger le mod√®le
                </button>
                <div class="file-upload" onclick="document.getElementById('importFileAutorises').click()" 
                     style="cursor: pointer; background: white; padding: 15px; border: 2px dashed #667eea; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 5px;">üìÑ</div>
                    <p style="margin: 0; font-size: 13px;">Cliquer pour importer</p>
                </div>
                <input type="file" id="importFileAutorises" style="display: none;" 
                       accept=".xlsx,.xls" onchange="importerEtudiantsAutorisesFichier(this)">
            </div>
        </div>
        
        <!-- Export -->
        <div style="background: #d4edda; padding: 20px; border-radius: 10px;">
            <h4 style="margin-bottom: 15px;">üìä Exporter Inscriptions</h4>
            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                Exportez la liste compl√®te des √©tudiants inscrits avec statistiques
            </p>
            <div style="display: flex; gap: 10px; flex-direction: column;">
                <button class="btn btn-success" onclick="exporterInscriptionsComplete()">
                    üì• Exporter toutes les inscriptions
                </button>
                <button class="btn btn-success" onclick="exporterInscriptionsValidees()">
                    ‚úÖ Exporter inscriptions valid√©es
                </button>
                <button class="btn btn-success" onclick="exporterParFiliere()">
                    üìö Exporter par fili√®re
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Import d'√©tudiants dans la base -->
<div class="dashboard-card" style="margin-bottom: 30px;">
    <h3>üë• Import d'√âtudiants</h3>
    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
        <h4 style="margin: 0 0 10px 0; color: #856404;">‚ö†Ô∏è Attention</h4>
        <p style="margin: 0; color: #856404; font-size: 13px;">
            Cette fonctionnalit√© permet d'importer des √©tudiants directement dans la base de donn√©es. 
            Assurez-vous que les donn√©es sont correctes avant l'import.
        </p>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div style="background: #e8f4ff; padding: 20px; border-radius: 10px;">
            <h4 style="margin-bottom: 15px;">üìã T√©l√©charger le mod√®le</h4>
            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                T√©l√©chargez le fichier Excel mod√®le avec toutes les instructions
            </p>
            <button class="btn btn-primary" onclick="telechargerModeleEtudiants()" style="width: 100%;">
                üì• T√©l√©charger le mod√®le Excel
            </button>
        </div>
        <div style="background: #d4edda; padding: 20px; border-radius: 10px;">
            <h4 style="margin-bottom: 15px;">üì§ Importer les √©tudiants</h4>
            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                Importez le fichier rempli avec les donn√©es des √©tudiants
            </p>
            <div class="file-upload" onclick="document.getElementById('importFileEtudiants').click()" 
                 style="cursor: pointer; background: white; padding: 15px; border: 2px dashed #28a745; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; margin-bottom: 5px;">üìÑ</div>
                <p style="margin: 0; font-size: 13px;">Cliquer pour importer</p>
            </div>
            <input type="file" id="importFileEtudiants" style="display: none;" 
                   accept=".xlsx,.xls" onchange="importerEtudiantsFichier(this)">
        </div>
    </div>
</div>
    <!-- Filtres et recherche -->
    <div class="dashboard-card" style="margin-bottom: 20px;">
        <div style="display: flex; gap: 15px; align-items: end;">
            <div class="form-group" style="flex: 1;">
                <label for="rechercheEtudiant">Rechercher</label>
                <input type="text" id="rechercheEtudiant" placeholder="Nom, matricule, n¬∞ dossier...">
            </div>
            <div class="form-group">
                <label for="filtreType">Type</label>
                <select id="filtreType">
                    <option value="">Tous</option>
                    <option value="nouveau">Nouveaux</option>
                    <option value="ancien">Anciens</option>
                </select>
            </div>
            <div class="form-group">
                <label for="filtreFiliere">Fili√®re</label>
                <select id="filtreFiliere">
                    <option value="">Toutes</option>
                </select>
            </div>
            <div class="form-group">
                <label for="filtreNiveau">Niveau</label>
                <select id="filtreNiveau">
                    <option value="">Tous</option>
                    <option value="L1">L1</option>
                    <option value="L2">L2</option>
                    <option value="L3">L3</option>
                    <option value="M1">M1</option>
                    <option value="M2">M2</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="chargerEtudiantsAutorises()">üîç Rechercher</button>
        </div>
    </div>

    <!-- Liste des √©tudiants -->
    <div class="dashboard-card">
        <h3>üìã Liste des √âtudiants</h3>
        <table class="table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                    <th>Matricule/N¬∞ Dossier</th>
                    <th>Nom Complet</th>
                    <th>Type</th>
                    <th>Fili√®re</th>
                    <th>Niveau</th>
                    <th>Autorisation</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableauEtudiants">
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                        Chargement...
                    </td>
                </tr>
            </tbody>
        </table>
        
        <!-- Actions group√©es -->
        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;" id="actionsGroupees">
            <strong><span id="countSelected">0</span> √©tudiant(s) s√©lectionn√©(s)</strong>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn btn-success" onclick="autoriserSelection()">‚úÖ Autoriser</button>
                <button class="btn btn-warning" onclick="bloquerSelection()">üö´ Bloquer</button>
            </div>
        </div>
    </div>
</div>

            <!-- Section Admin - Gestion des utilisateurs -->
            <div id="gestionUtilisateurs" class="page">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2>Gestion des utilisateurs</h2>
                    <div>
                        <button class="btn btn-secondary" onclick="showPage('adminPanel')">‚¨ÖÔ∏è Retour</button>
                        <button class="btn btn-primary" onclick="openModal('ajoutUtilisateurModal')">+ Ajouter un utilisateur</button>
                    </div>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Email</th>
                            <th>T√©l√©phone</th>
                            <th>Date d'inscription</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableauUtilisateurs">
                        <!-- Les donn√©es seront ajout√©es dynamiquement -->
                    </tbody>
                </table>
            </div>

            <!-- Section Admin - Gestion des dossiers -->
            <div id="gestionDossiers" class="page">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2>Gestion des dossiers</h2>
                    <button class="btn btn-secondary" onclick="showPage('adminPanel')">‚¨ÖÔ∏è Retour</button>
                </div>
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                  <div style="flex: 1;">
                    <input type="text" id="rechercheDossier" placeholder="Rechercher par num√©ro de dossier, nom, pr√©nom ou email..." style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                  </div>
                  <button class="btn btn-primary" onclick="rechercherDossiers()" style="padding: 8px 20px;">üîç Rechercher</button>
                  <button class="btn btn-secondary" onclick="reinitialiserRecherche()" style="padding: 8px 20px;">üîÑ R√©initialiser</button>
                </div>
                
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <select id="filtreStatut" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="">Tous les statuts</option>
                        <option value="en-attente">En attente</option>
                        <option value="approuve">Approuv√©</option>
                        <option value="rejete">Rejet√©</option>
                    </select>
                    <select id="filtreFiliere" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="">Toutes les fili√®res</option>
                        <option value="informatique">Informatique</option>
                        <option value="mathematiques">Math√©matiques</option>
                        <option value="physique">Physique</option>
                    </select>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Candidat</th>
                            <th>Numero dossier</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableauDossiersAdmin">
                        <!-- Les donn√©es seront ajout√©es dynamiquement -->
                    </tbody>
                </table>
            </div>
           <!-- Section Admin - Gestion des facult√©s et fili√®res -->
<div id="gestionFormations" class="page">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2>Gestion des formations</h2>
        <button class="btn btn-secondary" onclick="showPage('adminPanel')">‚¨ÖÔ∏è Retour</button>
    </div>

    <!-- Onglets -->
    <div class="tabs" style="margin-bottom: 30px;">
        <button class="tab-btn active" onclick="openFormationTab('facultes')">Facult√©s</button>
        <button class="tab-btn" onclick="openFormationTab('filieres')">Fili√®res</button>
        <button class="tab-btn" onclick="openFormationTab('diplomes')">Diplomes</button>
        <button class="tab-btn" onclick="openFormationTab('typeBacs')">Types de Bac</button>
    </div>

    <!-- Contenu des onglets -->
    <div id="facultes-tab" class="tab-content active">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>Gestion des facult√©s</h3>
            <button class="btn btn-primary" onclick="openModal('ajoutFaculteModal')">+ Ajouter une facult√©</button>
        </div>
        <table class="table">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Libell√©</th>
                    <th>Description</th>
                    <th>Nombre de fili√®res</th>
                    <th>Statut</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableauFacultes">
                <!-- Les donn√©es seront ajout√©es dynamiquement -->
            </tbody>
        </table>
    </div>
    <div id="diplomes-tab" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>Gestion des diplomes</h3>
            <button class="btn btn-primary" onclick="ouvrirModalDiplome()" id="btnAjoutDiplome">+ Ajouter un Diplome</button>
        </div>
        <table class="table">
            <thead>
                <tr>
        <th>Filiere</th>
        <th>Niveau</th>
        <th>Facult√©</th>
        <th>Statut</th>
        <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableauDiplomes">
                <!-- Les donn√©es seront ajout√©es dynamiquement -->
            </tbody>
        </table>
    </div>

    <div id="filieres-tab" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>Gestion des fili√®res</h3>
            <button class="btn btn-primary" onclick="ouvrirModalFiliere()" id="btnAjoutFiliere">+ Ajouter une fili√®re</button>
        </div>
        <table class="table">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Libell√©</th>
                    <th>Facult√©</th>
                    <th>Capacit√© max</th>
                    <th>Types de bac autoris√©s</th>
                    <th>Candidatures</th>
                    <th>Statut</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableauFilieres">
                <!-- Les donn√©es seront ajout√©es dynamiquement -->
            </tbody>
        </table>
    </div>

    

    <div id="typeBacs-tab" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>Gestion des types de bac</h3>
            <button class="btn btn-primary" onclick="openModal('ajoutTypeBacModal')">+ Ajouter un type de bac</button>
        </div>
        <table class="table">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Libell√©</th>
                    <th>Description</th>
                    <th>Nombre de fili√®res</th>
                    <th>Statut</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableauTypeBacs">
                <!-- Les donn√©es seront ajout√©es dynamiquement -->
            </tbody>
        </table>
    </div>
</div>

            <!-- Section Admin - Statistiques -->
            <!-- Remplacer la section statistiques existante dans votre index.html -->
<div id="statistiques" class="page">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2>Statistiques Avanc√©es</h2>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="showPage('adminPanel')">‚¨ÖÔ∏è Retour</button>
            <button class="btn btn-primary" onclick="exporterToutesStatistiques()">üìä Export Complet</button>
        </div>
    </div>

    <!-- Navigation par onglets -->
    <div class="tabs" style="margin-bottom: 30px;">
        <button class="tab-btn active" onclick="ouvrirOngletStats(event, 'tableau-bord')">üìà Tableau de Bord</button>
        <button class="tab-btn" onclick="ouvrirOngletStats(event, 'genre')">üë• Par Genre</button>
        <button class="tab-btn" onclick="ouvrirOngletStats(event, 'type-bac')">üéì Par Type de Bac</button>
        <button class="tab-btn" onclick="ouvrirOngletStats(event, 'facultes')">üèõÔ∏è Par Facult√©</button>
        <button class="tab-btn" onclick="ouvrirOngletStats(event, 'filieres')">üìö Par Fili√®re</button>
        <button class="tab-btn" onclick="ouvrirOngletStats(event, 'temporelles')">üìÖ √âvolution</button>
        <button class="tab-btn" onclick="ouvrirOngletStats(event, 'avancees')">üîç Analyses Avanc√©es</button>
    </div>

    <!-- Tableau de Bord Principal -->
    <div id="stats-tableau-bord" class="stats-tab-content active">
        <!-- R√©sum√© g√©n√©ral -->
        <div class="dashboard-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 30px;">
            <div class="dashboard-card" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                <div class="card-icon" style="color: white;">üìä</div>
                <div class="card-title">Total Candidatures</div>
                <div style="font-size: 32px; font-weight: bold;" id="statTotalCandidatures">0</div>
            </div>
            <div class="dashboard-card" style="background: linear-gradient(135deg, #28a745, #20c997); color: white;">
                <div class="card-icon" style="color: white;">‚úÖ</div>
                <div class="card-title">Approuv√©es</div>
                <div style="font-size: 32px; font-weight: bold;" id="statApprouvees">0</div>
            </div>
            <div class="dashboard-card" style="background: linear-gradient(135deg, #17a2b8, #6f42c1); color: white;">
                <div class="card-icon" style="color: white;">üë®</div>
                <div class="card-title">Hommes</div>
                <div style="font-size: 32px; font-weight: bold;" id="statHommes">0</div>
            </div>
            <div class="dashboard-card" style="background: linear-gradient(135deg, #e83e8c, #fd7e14); color: white;">
                <div class="card-icon" style="color: white;">üë©</div>
                <div class="card-title">Femmes</div>
                <div style="font-size: 32px; font-weight: bold;" id="statFemmes">0</div>
            </div>
        </div>

        <!-- Graphiques principaux -->
        <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
            <div class="dashboard-card">
                <h3>Top 5 des Fili√®res</h3>
                <div style="position: relative; height: 300px;">
                    <canvas id="chartTopFilieres"></canvas>
                </div>
            </div>
            <div class="dashboard-card">
                <h3>R√©partition par Type de Bac</h3>
                <div style="position: relative; height: 300px;">
                    <canvas id="chartRepartitionBac"></canvas>
                </div>
            </div>
        </div>

        <!-- √âvolution temporelle -->
        <div class="dashboard-card" style="margin-top: 20px;">
            <h3>üìà √âvolution des 6 Derniers Mois</h3>
            <div style="position: relative; height: 350px;">
                <canvas id="chartEvolution"></canvas>
            </div>
        </div>
    </div>

    <!-- Statistiques par Genre -->
    <div id="stats-genre" class="stats-tab-content">
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3>üë• R√©partition par Genre</h3>
                <div style="position: relative; height: 300px;">
                    <canvas id="chartGenre"></canvas>
                </div>
                <div id="detailsGenre" style="margin-top: 20px;"></div>
            </div>
            <div class="dashboard-card">
                <h3>üìä Taux d'Approbation par Genre</h3>
                <div style="position: relative; height: 300px;">
                    <canvas id="chartGenreApprobation"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Tableau d√©taill√© -->
        <div class="dashboard-card" style="margin-top: 20px;">
            <h3>üìã D√©tails par Genre</h3>
            <table class="table" id="tableauGenre">
                <thead>
                    <tr>
                        <th>Genre</th>
                        <th>Total Candidatures</th>
                        <th>Approuv√©es</th>
                        <th>Rejet√©es</th>
                        <th>En Attente</th>
                        <th>Taux d'Approbation</th>
                    </tr>
                </thead>
                <tbody id="detailsTableauGenre"></tbody>
            </table>
        </div>
    </div>

    <!-- Statistiques par Type de Bac -->
    <div id="stats-type-bac" class="stats-tab-content">
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3>üéì Distribution par Type de Bac</h3>
                <div style="position: relative; height: 300px;">
                    <canvas id="chartTypeBac"></canvas>
                </div>
            </div>
            <div class="dashboard-card">
                <h3>üìà Performances par Type de Bac</h3>
                <div style="position: relative; height: 300px;">
                    <canvas id="chartTypeBacPerformance"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques par Facult√© -->
    <div id="stats-facultes" class="stats-tab-content">
        <div class="dashboard-card">
            <h3>üèõÔ∏è R√©partition des Choix par Facult√©</h3>
            <div style="position: relative; height: 400px;">
                <canvas id="chartFacultes"></canvas>
            </div>
        </div>
        
        <!-- D√©tails par facult√© -->
        <div class="dashboard-grid" style="margin-top: 20px;">
            <div class="dashboard-card">
                <h3>üéØ Pr√©f√©rences de Choix</h3>
                <div style="position: relative; height: 300px;">
                    <canvas id="chartChoixFacultes"></canvas>
                </div>
            </div>
            <div class="dashboard-card">
                <h3>üìä Taux de Succ√®s par Facult√©</h3>
                <div id="detailsFacultes"></div>
            </div>
        </div>
    </div>

    <!-- Statistiques par Fili√®re -->
    <div id="stats-filieres" class="stats-tab-content">
        <div class="dashboard-card">
            <h3>üìö Top 15 des Fili√®res les Plus Demand√©es</h3>
            <div style="position: relative; height: 500px;">
                <canvas id="chartFilieres"></canvas>
            </div>
        </div>
        
        <div class="dashboard-card" style="margin-top: 20px;">
            <h3>üìã D√©tails par Fili√®re</h3>
            <div style="max-height: 400px; overflow-y: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Fili√®re</th>
                            <th>Total</th>
                            <th>Approuv√©es</th>
                            <th>Taux d'Approbation</th>
                            <th>Popularit√©</th>
                        </tr>
                    </thead>
                    <tbody id="detailsFilieres"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Statistiques Temporelles -->
    <div id="stats-temporelles" class="stats-tab-content">
        <div class="dashboard-card">
            <h3>üìÖ √âvolution Temporelle des Candidatures</h3>
            <div style="position: relative; height: 400px;">
                <canvas id="chartTemporel"></canvas>
            </div>
        </div>
        
        <div class="dashboard-grid" style="margin-top: 20px;">
            <div class="dashboard-card">
                <h3>üìä Tendances Mensuelles</h3>
                <div style="position: relative; height: 300px;">
                    <canvas id="chartTendances"></canvas>
                </div>
            </div>
            <div class="dashboard-card">
                <h3>üéØ Pic d'Activit√©</h3>
                <div id="analyseActivite"></div>
            </div>
        </div>
    </div>

    <!-- Analyses Avanc√©es -->
    <div id="stats-avancees" class="stats-tab-content">
        <h3 style="text-align: center; margin-bottom: 30px; color: #667eea;">üîç Analyses Crois√©es et Insights</h3>
        
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3>üë•√óüéì Genre √ó Type de Bac</h3>
                <div style="position: relative; height: 300px;">
                    <canvas id="chartGenreBac"></canvas>
                </div>
            </div>
            <div class="dashboard-card">
                <h3>üèÜ Mentions par Fili√®re</h3>
                <div style="position: relative; height: 300px;">
                    <canvas id="chartMentionsFilieres"></canvas>
                </div>
            </div>
        </div>
        
        <div class="dashboard-grid" style="margin-top: 20px;">
            <div class="dashboard-card">
                <h3>üåç R√©partition G√©ographique</h3>
                <div style="position: relative; height: 300px;">
                    <canvas id="chartLieuObtention"></canvas>
                </div>
            </div>
            <div class="dashboard-card">
                <h3>üìà Indices de Performance</h3>
                <div id="indicesPerformance">
                    <div style="text-align: center; padding: 20px;">
                        <div class="stat-badge primary" style="display: block; margin: 10px 0; padding: 10px;">
                            <strong>Taux Global d'Approbation</strong>
                            <div style="font-size: 24px; margin-top: 5px;" id="tauxGlobalApprobation">--%</div>
                        </div>
                        <div class="stat-badge success" style="display: block; margin: 10px 0; padding: 10px;">
                            <strong>Fili√®re la Plus Demand√©e</strong>
                            <div style="margin-top: 5px;" id="filierePlusDemanndee">--</div>
                        </div>
                        <div class="stat-badge warning" style="display: block; margin: 10px 0; padding: 10px;">
                            <strong>Diversit√© des Profils</strong>
                            <div style="margin-top: 5px;" id="diversiteProfils">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Insights automatiques -->
        <div class="dashboard-card" style="margin-top: 20px;">
            <h3>üß† Insights Automatiques</h3>
            <div id="insightsAutomatiques" style="padding: 20px;">
                <div style="text-align: center; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üìä</div>
                    <p>Chargement des analyses en cours...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Boutons d'export par section -->
    <div style="position: fixed; bottom: 20px; right: 20px; z-index: 100;">
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn btn-primary" onclick="exporterStatistiquesActuelles()" 
                    style="border-radius: 50px; padding: 12px 20px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                üíæ Export Section
            </button>
            <button class="btn btn-secondary" onclick="imprimerRapport()" 
                    style="border-radius: 50px; padding: 12px 20px;">
                üñ®Ô∏è Imprimer
            </button>
        </div>
    </div>
</div>


            <!-- Section Admin - Import/Export -->
           <div id="importExport" class="page">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2>Import/Export des donn√©es</h2>
        <button class="btn btn-secondary" onclick="showPage('adminPanel')">‚¨ÖÔ∏è Retour</button>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        
        <!-- EXPORTS -->
        <div style="background: #f8f9fa; padding: 25px; border-radius: 15px;">
            <h3 style="color: #667eea; margin-bottom: 20px;">üì§ Export des donn√©es</h3>
            
            <!-- Export Excel Dossiers Approuv√©s - NOUVEAU -->
            <div style="background: #e8f4ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                <h4 style="color: #28a745; margin: 0 0 10px 0;">üìä Export Excel Complet</h4>
                <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
                    Export Excel avec 3 onglets : Dossiers approuv√©s, Statistiques par facult√©, Par fili√®re
                </p>
                <button class="btn" style="width: 100%; background: #28a745; color: white;" 
        onclick="exporterApprouvesExcel()">
    üì• T√©l√©charger Excel Dossiers Approuv√©s
</button>
            </div>
            
            <!-- Exports par section -->
            <div style="margin-bottom: 15px;">
                <h4 style="margin-bottom: 10px;">Par Section</h4>
                
                <button class="btn btn-primary" onclick="exporterParFaculte()" style="width: 100%; margin-bottom: 10px;">
    üèõÔ∏è Export par Facult√© (Excel)
</button>

<button class="btn btn-primary" onclick="exporterParGenre()" style="width: 100%; margin-bottom: 10px;">
    üë• Export par Genre (Excel)
</button>

<button class="btn btn-primary" onclick="exporterParStatut()" style="width: 100%; margin-bottom: 10px;">
    üìä Export par Statut (Excel)
</button>
            </div>
            
            <!-- Exports classiques -->
            <div style="border-top: 2px solid #ddd; padding-top: 15px; margin-top: 15px;">
                <h4 style="margin-bottom: 10px;">Exports Classiques (CSV)</h4>
                
                <button class="btn btn-secondary" onclick="exportData('users')" style="width: 100%; margin-bottom: 10px;">
                    üë§ Exporter les utilisateurs
                </button>
                
                <button class="btn btn-secondary" onclick="apiClient.exportCandidaturesComplete()" style="width: 100%; margin-bottom: 10px;">
                    üìã Export Candidatures Complet (CSV)
                </button>
                
                <button class="btn btn-secondary" onclick="exportData('applications')" style="width: 100%;">
                    üìÑ Export Simple Candidatures
                </button>
            </div>
        </div>
        
        <!-- IMPORT -->
        <div style="background: #f8f9fa; padding: 25px; border-radius: 15px;">
            <h3 style="color: #667eea; margin-bottom: 20px;">üì• Import des donn√©es</h3>
            
            <div class="file-upload" onclick="document.getElementById('importFile').click()">
                <div class="file-upload-icon">üìÅ</div>
                <p>Cliquez pour importer un fichier</p>
                <p style="font-size: 12px; color: #666;">Formats accept√©s: CSV, JSON</p>
            </div>
            <input type="file" id="importFile" style="display: none;" accept=".csv,.json" onchange="importData(this)">
            
            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                <h4 style="color: #856404; margin: 0 0 10px 0;">‚ÑπÔ∏è Information</h4>
                <p style="font-size: 13px; color: #856404; margin: 0;">
                    L'import de donn√©es n√©cessite un fichier au format sp√©cifique. 
                    Contactez l'administrateur syst√®me pour plus d'informations.
                </p>
            </div>
        </div>
    </div>
 
        </main>
    </div>

    <!-- Modal d'ajout/modification de facult√© -->
<div id="ajoutFaculteModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close" onclick="closeModal('ajoutFaculteModal')">&times;</span>
        <h3 id="titreFaculteModal">Ajouter une facult√©</h3>
        <form id="faculteForm" onsubmit="sauvegarderFaculte(event)">
            <div class="form-group">
                <label for="faculteNom">Nom *</label>
                <input type="text" id="faculteNom" required placeholder="Ex: FADEG">
            </div>
            <div class="form-group">
                <label for="faculteLibelle">Libell√© *</label>
                <input type="text" id="faculteLibelle" required placeholder="Ex: Facult√© de Droit d'√âconomie et de Gestion">
            </div>
            <div class="form-group">
                <label for="faculteDescription">Description</label>
                <textarea id="faculteDescription" rows="3" placeholder="Description de la facult√©..."></textarea>
            </div>
            <div class="form-group">
                <label for="faculteActive">
                    <input type="checkbox" id="faculteActive" checked> Active
                </label>
            </div>
            <input type="hidden" id="faculteId">
            <button type="submit" class="btn btn-primary" style="width: 100%;">Enregistrer</button>
        </form>
    </div>
</div>

<!-- Modal d'ajout/modification de fili√®re -->
<div id="ajoutFiliereModal" class="modal">
    <div class="modal-content" style="max-width: 700px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column;">
        <!-- Header -->
        <div style="flex-shrink: 0; padding-bottom: 15px; border-bottom: 1px solid #e1e5e9;">
            <span class="close" onclick="closeModal('ajoutFiliereModal')">&times;</span>
            <h3 id="titreFiliereModal" style="margin: 0;">Ajouter une fili√®re</h3>
        </div>
        
        <!-- Contenu avec d√©filement -->
        <div style="flex: 1; overflow-y: auto; padding: 15px 0;">
            <form id="filiereForm" onsubmit="sauvegarderFiliere(event)">
                <!-- Vos champs de formulaire existants ici -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="filiereNom">Nom *</label>
                        <input type="text" id="filiereNom" required placeholder="Ex: INFORMATIQUE">
                    </div>
                    <div class="form-group">
                        <label for="filiereLibelle">Libell√© *</label>
                        <input type="text" id="filiereLibelle" required placeholder="Ex: Informatique">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="filiereFaculte">Facult√© *</label>
                        <select id="filiereFaculte" required>
                            <option value="">S√©lectionner une facult√©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filiereCapacite">Capacit√© maximale</label>
                        <input type="number" id="filiereCapacite" placeholder="Ex: 150">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="filiereDescription">Description</label>
                    <textarea id="filiereDescription" rows="2" placeholder="Description de la fili√®re..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Types de bac autoris√©s *</label>
                    <div id="typesBacContainer" style="max-height: 120px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 8px; padding: 10px; background: #fafafa; margin-bottom: 10px;">
                        <!-- Les cases √† cocher seront ajout√©es dynamiquement -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="filiereActive">
                        <input type="checkbox" id="filiereActive" checked> Active
                    </label>
                </div>
                
                <input type="hidden" id="filiereId">
            </form>
        </div>
        
        <!-- Bouton fixe en bas -->
        <div style="flex-shrink: 0; padding-top: 15px; border-top: 1px solid #e1e5e9; background: white;">
            <button type="submit" form="filiereForm" class="btn btn-primary" style="width: 100%;">Enregistrer</button>
        </div>
    </div>
</div>

<div id="ajoutDiplomeModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <span class="close" onclick="closeModal('ajoutDiplomeModal')">&times;</span>
        <h3 id="titreDiplomeModal">Ajouter un Dipl√¥me</h3>
        
        <form id="diplomeForm" onsubmit="sauvegarderDiplome(event)">
            <!-- ORDRE MODIFI√â : Facult√© d'abord -->
            <div class="form-group">
                <label for="diplomeFaculte">Facult√© *</label>
                <select id="diplomeFaculte" required onchange="chargerFilieresParFaculte()">
                    <option value="">S√©lectionner une facult√©</option>
                </select>
            </div>
            
            <!-- Fili√®re ensuite (se charge automatiquement) -->
            <div class="form-group">
                <label for="diplomeFiliere">Fili√®re *</label>
                <select id="diplomeFiliere" required>
                    <option value="">S√©lectionner d'abord une facult√©</option>
                </select>
                <div class="form-hint">
                    <small>üí° Les fili√®res disponibles d√©pendent de la facult√© s√©lectionn√©e</small>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="diplomeLibelle">Niveau *</label>
                    <input type="text" id="diplomeLibelle" required placeholder="Ex: DUT, LICENCE">
                </div>
            </div>
            
            <input type="hidden" id="diplomeId">
            
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">Enregistrer</button>
        </form>
    </div>
</div>

<!-- Modal d'ajout/modification de type de bac -->
<div id="ajoutTypeBacModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close" onclick="closeModal('ajoutTypeBacModal')">&times;</span>
        <h3 id="titreTypeBacModal">Ajouter un type de bac</h3>
        <form id="typeBacForm" onsubmit="sauvegarderTypeBac(event)">
            <div class="form-group">
                <label for="typeBacNom">Nom *</label>
                <input type="text" id="typeBacNom" required placeholder="Ex: BAC A">
            </div>
            <div class="form-group">
                <label for="typeBacLibelle">Niveau *</label>
                <input type="text" id="typeBacLibelle" required placeholder="Ex: Baccalaur√©at A">
            </div>
            <div class="form-group">
                <label for="typeBacDescription">Description</label>
                <textarea id="typeBacDescription" rows="3" placeholder="Description du type de bac..."></textarea>
            </div>
            <div class="form-group">
                <label for="typeBacActive">
                    <input type="checkbox" id="typeBacActive" checked> Active
                </label>
            </div>
            <input type="hidden" id="typeBacId">
            <button type="submit" class="btn btn-primary" style="width: 100%;">Enregistrer</button>
        </form>
    </div>
</div>

    <!-- Modals -->
    <div id="ajoutUtilisateurModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('ajoutUtilisateurModal')">&times;</span>
            <h3 style="margin-bottom: 20px;">Ajouter un utilisateur</h3>
            <form id="ajoutUtilisateurForm" onsubmit="ajouterUtilisateur(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label for="adminNom">Nom complet</label>
                        <input type="text" id="adminNom" required>
                    </div>
                    <div class="form-group">
                        <label for="adminEmail">Email</label>
                        <input type="email" id="adminEmail" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="adminTelephone">T√©l√©phone</label>
                        <input type="tel" id="adminTelephone" required>
                    </div>
                    <div class="form-group">
                        <label for="adminRole">R√¥le</label>
                        <select id="adminRole" required>
                            <option value="user">Utilisateur</option>
                            <option value="admin">Administrateur</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="adminMotDePasse">Mot de passe temporaire</label>
                    <input type="password" id="adminMotDePasse" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">Ajouter</button>
            </form>
        </div>
    </div>

    <div id="confirmationModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('confirmationModal')">&times;</span>
    <h3 style="margin-bottom: 20px; text-align: center;">üéâ Dossier valid√© avec succ√®s!</h3>
    <p style="text-align: center; margin-bottom: 30px;">
      Votre dossier a √©t√© soumis avec succ√®s. Vous pouvez maintenant t√©l√©charger votre quitus dans votre tableau de bord.
    </p>
    <div style="text-align: center;">
      <button class="btn btn-secondary" onclick="closeModal('confirmationModal'); showPage('dashboard');">
        Retour au tableau de bord
      </button>
    </div>
  </div>
</div>

    <script src="apiClient.js"></script>
    
    <script>
// T√©l√©charger le mod√®le d'import pour √©tudiants
async function telechargerModeleEtudiants() {
    try {
        UIHelpers.showLoading(true);
        
        const response = await fetch(`${API_BASE_URL}/admin/etudiants/modele-import`, {
            headers: {
                'Authorization': `Bearer ${apiClient.token}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Erreur lors du t√©l√©chargement');
        }
        
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Modele_Import_Etudiants.xlsx';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        UIHelpers.showSuccess('Mod√®le t√©l√©charg√© avec succ√®s');
        
    } catch (error) {
        console.error('Erreur t√©l√©chargement mod√®le:', error);
        UIHelpers.showError('Erreur lors du t√©l√©chargement du mod√®le');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Importer les √©tudiants depuis un fichier Excel
async function importerEtudiantsFichier(input) {
    const file = input.files[0];
    if (!file) return;
    
    if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
        UIHelpers.showError('Veuillez s√©lectionner un fichier Excel (.xlsx ou .xls)');
        input.value = '';
        return;
    }
    
    if (!confirm('√ätes-vous s√ªr de vouloir importer ces √©tudiants ? Cette action ajoutera de nouvelles entr√©es dans la base de donn√©es.')) {
        input.value = '';
        return;
    }
    
    try {
        UIHelpers.showLoading(true);
        
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetch(`${API_BASE_URL}/admin/etudiants/import-excel`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiClient.token}`
            },
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            let message = `Import termin√©!\n\n`;
            message += `‚úÖ ${result.imported} √©tudiant(s) import√©(s)\n`;
            message += `üìä ${result.total_processed} ligne(s) trait√©e(s)\n`;
            
            if (result.duplicates > 0) {
                message += `‚ö†Ô∏è ${result.duplicates} doublon(s) ignor√©(s)\n`;
            }
            
            if (result.errors && result.errors.length > 0) {
                message += `\n‚ùå ${result.total_errors} erreur(s) d√©tect√©e(s):\n`;
                message += result.errors.slice(0, 10).join('\n');
                if (result.total_errors > 10) {
                    message += `\n... et ${result.total_errors - 10} autre(s)`;
                }
            }
            
            alert(message);
            
            if (result.imported > 0) {
                UIHelpers.showSuccess(`${result.imported} √©tudiant(s) import√©(s) avec succ√®s`);
                await chargerEtudiantsAutorises();
            }
        } else {
            throw new Error(result.error || 'Erreur lors de l\'import');
        }
        
    } catch (error) {
        console.error('Erreur import:', error);
        UIHelpers.showError('Erreur lors de l\'import: ' + error.message);
    } finally {
        UIHelpers.showLoading(false);
        input.value = '';
    }
}
// T√©l√©charger le mod√®le d'import
async function telechargerModeleImport() {
    try {
        UIHelpers.showLoading(true);
        
        const response = await fetch(`${API_BASE_URL}/admin/inscription/modele-import`, {
            headers: {
                'Authorization': `Bearer ${apiClient.token}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Erreur lors du t√©l√©chargement');
        }
        
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Modele_Import_Etudiants_Autorises.xlsx';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        UIHelpers.showSuccess('Mod√®le t√©l√©charg√© avec succ√®s');
        
    } catch (error) {
        console.error('Erreur t√©l√©chargement mod√®le:', error);
        UIHelpers.showError('Erreur lors du t√©l√©chargement du mod√®le');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Importer les √©tudiants autoris√©s depuis un fichier Excel
async function importerEtudiantsAutorisesFichier(input) {
    const file = input.files[0];
    if (!file) return;
    
    if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
        UIHelpers.showError('Veuillez s√©lectionner un fichier Excel (.xlsx ou .xls)');
        input.value = '';
        return;
    }
    
    try {
        UIHelpers.showLoading(true);
        
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetch(`${API_BASE_URL}/admin/inscription/import-autorises-excel`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiClient.token}`
            },
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            let message = `Import r√©ussi!\n\n`;
            message += `‚úÖ ${result.imported} √©tudiant(s) autoris√©(s)\n`;
            message += `üö´ ${result.updated} √©tudiant(s) bloqu√©(s)\n`;
            message += `üìä ${result.total_processed} lignes trait√©es`;
            
            if (result.errors && result.errors.length > 0) {
                message += `\n\n‚ö†Ô∏è ${result.errors.length} erreur(s):\n`;
                message += result.errors.slice(0, 5).join('\n');
                if (result.errors.length > 5) {
                    message += `\n... et ${result.errors.length - 5} autre(s)`;
                }
            }
            
            alert(message);
            UIHelpers.showSuccess('Import termin√© avec succ√®s');
            
            // Recharger la liste
            await chargerEtudiantsAutorises();
        } else {
            throw new Error(result.error || 'Erreur lors de l\'import');
        }
        
    } catch (error) {
        console.error('Erreur import:', error);
        UIHelpers.showError('Erreur lors de l\'import: ' + error.message);
    } finally {
        UIHelpers.showLoading(false);
        input.value = '';
    }
}

// Exporter toutes les inscriptions
// Exporter les inscriptions valid√©es uniquement
async function exporterInscriptionsValidees() {
    try {
        UIHelpers.showLoading(true);
        
        const response = await fetch(`${API_BASE_URL}/admin/inscription/export-inscrits?statut=valid√©e`, {
            headers: {
                'Authorization': `Bearer ${apiClient.token}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Erreur lors de l\'export');
        }
        
        const blob = await response.blob();
        const filename = `Inscriptions_Validees_${new Date().toISOString().split('T')[0]}.xlsx`;
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        UIHelpers.showSuccess('Export t√©l√©charg√© avec succ√®s');
        
    } catch (error) {
        console.error('Erreur export:', error);
        UIHelpers.showError('Erreur lors de l\'export');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Exporter par fili√®re (avec dialogue de s√©lection)
async function exporterParFiliere() {
    try {
        // Charger les fili√®res disponibles
        const response = await apiClient.getFilieres();
        const filieres = response.filieres || [];
        
        if (filieres.length === 0) {
            UIHelpers.showError('Aucune fili√®re disponible');
            return;
        }
        
        // Cr√©er un dialogue de s√©lection
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 500px;">
                <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                <h3 style="margin-bottom: 20px;">S√©lectionner une fili√®re</h3>
                <div class="form-group">
                    <label for="exportFiliereSelect">Fili√®re *</label>
                    <select id="exportFiliereSelect" style="width: 100%;">
                        <option value="">S√©lectionner une fili√®re</option>
                        ${filieres.map(f => 
                            `<option value="${f.id}">${f.nom} - ${f.libelle} (${f.faculte_libelle})</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label for="exportNiveauSelect">Niveau (optionnel)</label>
                    <select id="exportNiveauSelect" style="width: 100%;">
                        <option value="">Tous les niveaux</option>
                        <option value="L1">L1</option>
                        <option value="L2">L2</option>
                        <option value="L3">L3</option>
                        <option value="M1">M1</option>
                        <option value="M2">M2</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="confirmerExportFiliere()" style="width: 100%; margin-top: 20px;">
                    Exporter
                </button>
            </div>
        `;
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Erreur:', error);
        UIHelpers.showError('Erreur lors de la pr√©paration de l\'export');
    }
}

// Confirmer et ex√©cuter l'export par fili√®re
async function confirmerExportFiliere() {
    const filiereId = document.getElementById('exportFiliereSelect').value;
    const niveau = document.getElementById('exportNiveauSelect').value;
    
    if (!filiereId) {
        UIHelpers.showError('Veuillez s√©lectionner une fili√®re');
        return;
    }
    
    try {
        UIHelpers.showLoading(true);
        
        // Fermer le modal
        document.querySelector('.modal').remove();
        
        const params = new URLSearchParams();
        params.append('filiere_id', filiereId);
        if (niveau) params.append('niveau', niveau);
        
        const response = await fetch(`${API_BASE_URL}/admin/inscription/export-inscrits?${params.toString()}`, {
            headers: {
                'Authorization': `Bearer ${apiClient.token}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Erreur lors de l\'export');
        }
        
        const blob = await response.blob();
        const filename = `Inscriptions_Filiere_${filiereId}_${niveau || 'Tous'}${new Date().toISOString().split('T')[0]}.xlsx`;
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        UIHelpers.showSuccess('Export t√©l√©charg√© avec succ√®s');
        
    } catch (error) {
        console.error('Erreur export:', error);
        UIHelpers.showError('Erreur lors de l\'export');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Exporter les inscriptions valid√©es uniquement
    // Variables globales
let etudiantsData = [];
let selectedEtudiants = new Set();

// Charger les √©tudiants autoris√©s
async function chargerEtudiantsAutorises() {
    try {
        UIHelpers.showLoading(true);
        
        const type = document.getElementById('filtreType').value;
        const filiere_id = document.getElementById('filtreFiliere').value;
        const niveau = document.getElementById('filtreNiveau').value;
        const search = document.getElementById('rechercheEtudiant').value;
        
        const params = new URLSearchParams();
        if (type) params.append('type', type);
        if (filiere_id) params.append('filiere_id', filiere_id);
        if (niveau) params.append('niveau', niveau);
        if (search) params.append('search', search);
        
        const response = await apiClient.getEtudiantsAutorises(params.toString());
        etudiantsData = response.etudiants || [];
        
        afficherEtudiants(etudiantsData);
        mettreAJourStatistiques(etudiantsData);
        
    } catch (error) {
        console.error('Erreur chargement √©tudiants:', error);
        UIHelpers.showError('Erreur lors du chargement des √©tudiants');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Afficher les √©tudiants dans le tableau
function afficherEtudiants(etudiants) {
    const tbody = document.getElementById('tableauEtudiants');
    tbody.innerHTML = '';
    
    if (etudiants.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #666;">Aucun √©tudiant trouv√©</td></tr>';
        return;
    }
    
    etudiants.forEach(etudiant => {
        const autorise = etudiant.autorise_annee !== null ? etudiant.autorise_annee : etudiant.autorise_inscription;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="checkbox" class="etudiant-checkbox" value="${etudiant.id}" onchange="updateSelection()"></td>
            <td>${etudiant.matricule || etudiant.numero_dossier}</td>
            <td><strong>${etudiant.nom} ${etudiant.prenom}</strong><br><small>${etudiant.email}</small></td>
            <td><span class="stat-badge ${etudiant.type === 'nouveau' ? 'primary' : 'success'}">${etudiant.type === 'nouveau' ? 'üÜï Nouveau' : 'üéì Ancien'}</span></td>
            <td>${etudiant.filiere_libelle || '-'}</td>
            <td>${etudiant.niveau || '-'}</td>
            <td>
                ${autorise ? 
                    '<span class="status-badge status-approved">‚úÖ Autoris√©</span>' : 
                    '<span class="status-badge status-rejected">üö´ Bloqu√©</span>'}
                ${etudiant.raison_blocage ? `<br><small style="color: #666;">${etudiant.raison_blocage}</small>` : ''}
            </td>
            <td>
                <button class="btn ${autorise ? 'btn-warning' : 'btn-success'}" style="padding: 5px 10px;" 
                        onclick="toggleAutorisationIndividuelle(${etudiant.id}, ${!autorise})">
                    ${autorise ? 'üö´ Bloquer' : '‚úÖ Autoriser'}
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Mettre √† jour les statistiques
function mettreAJourStatistiques(etudiants) {
    document.getElementById('statTotalEtudiants').textContent = etudiants.length;
    document.getElementById('statAutorises').textContent = etudiants.filter(e => 
        (e.autorise_annee !== null ? e.autorise_annee : e.autorise_inscription)
    ).length;
    document.getElementById('statNouveaux').textContent = etudiants.filter(e => e.type === 'nouveau').length;
    document.getElementById('statAnciens').textContent = etudiants.filter(e => e.type === 'ancien').length;
}

// Toggle autorisation individuelle
async function toggleAutorisationIndividuelle(etudiantId, autorise) {
    const raison = !autorise ? prompt('Raison du blocage (optionnel):') : null;
    
    try {
        UIHelpers.showLoading(true);
        
        await apiClient.toggleAutorisationEtudiant(etudiantId, autorise, raison);
        UIHelpers.showSuccess(`√âtudiant ${autorise ? 'autoris√©' : 'bloqu√©'} avec succ√®s`);
        
        await chargerEtudiantsAutorises();
        
    } catch (error) {
        console.error('Erreur toggle autorisation:', error);
        UIHelpers.showError('Erreur lors de la modification');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Gestion de la s√©lection
function updateSelection() {
    selectedEtudiants.clear();
    document.querySelectorAll('.etudiant-checkbox:checked').forEach(cb => {
        selectedEtudiants.add(parseInt(cb.value));
    });
    
    const count = selectedEtudiants.size;
    document.getElementById('countSelected').textContent = count;
    document.getElementById('actionsGroupees').style.display = count > 0 ? 'block' : 'none';
}

function toggleSelectAll() {
    const checked = document.getElementById('selectAll').checked;
    document.querySelectorAll('.etudiant-checkbox').forEach(cb => {
        cb.checked = checked;
    });
    updateSelection();
}

// Autoriser la s√©lection
// Autoriser la s√©lection
async function autoriserSelection() {
    if (selectedEtudiants.size === 0) return;
    
    if (!confirm(`Autoriser ${selectedEtudiants.size} √©tudiant(s) ?`)) return;
    
    try {
        UIHelpers.showLoading(true);
        
        for (const id of selectedEtudiants) {
            await apiClient.toggleAutorisationEtudiant(id, true, null);
        }
        
        UIHelpers.showSuccess(`${selectedEtudiants.size} √©tudiant(s) autoris√©(s)`);
        selectedEtudiants.clear();
        await chargerEtudiantsAutorises();
        
    } catch (error) {
        console.error('Erreur autorisation:', error);
        UIHelpers.showError('Erreur lors de l\'autorisation');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Bloquer la s√©lection
async function bloquerSelection() {
    if (selectedEtudiants.size === 0) return;
    
    const raison = prompt('Raison du blocage (optionnel):');
    if (raison === null) return; // Annul√©
    
    try {
        UIHelpers.showLoading(true);
        
        for (const id of selectedEtudiants) {
            await apiClient.toggleAutorisationEtudiant(id, false, raison);
        }
        
        UIHelpers.showSuccess(`${selectedEtudiants.size} √©tudiant(s) bloqu√©(s)`);
        selectedEtudiants.clear();
        await chargerEtudiantsAutorises();
        
    } catch (error) {
        console.error('Erreur blocage:', error);
        UIHelpers.showError('Erreur lors du blocage');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Autoriser tous les √©tudiants
async function autoriserTous() {
    if (!confirm('Autoriser TOUS les √©tudiants √† s\'inscrire ?')) return;
    
    try {
        UIHelpers.showLoading(true);
        
        await apiClient.request('/admin/inscription/autoriser-type', {
            method: 'POST',
            body: JSON.stringify({ type: null, autorise: true })
        });
        
        UIHelpers.showSuccess('Tous les √©tudiants ont √©t√© autoris√©s');
        await chargerEtudiantsAutorises();
        
    } catch (error) {
        console.error('Erreur:', error);
        UIHelpers.showError('Erreur lors de l\'autorisation');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Bloquer tous les √©tudiants
async function bloquerTous() {
    if (!confirm('BLOQUER tous les √©tudiants ? Cette action peut √™tre annul√©e.')) return;
    
    const raison = prompt('Raison du blocage (optionnel):');
    if (raison === null) return;
    
    try {
        UIHelpers.showLoading(true);
        
        // Bloquer via update global
        await apiClient.request('/admin/inscription/autoriser-type', {
            method: 'POST',
            body: JSON.stringify({ type: null, autorise: false })
        });
        
        UIHelpers.showSuccess('Tous les √©tudiants ont √©t√© bloqu√©s');
        await chargerEtudiantsAutorises();
        
    } catch (error) {
        console.error('Erreur:', error);
        UIHelpers.showError('Erreur lors du blocage');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Configurer les autorisations globales
async function configurerAutorisations(event) {
    event.preventDefault();
    
    try {
        UIHelpers.showLoading(true);
        
        const typeAutorisation = document.getElementById('typeAutorisation').value;
        let filieres_autorisees = null;
        let niveaux_autorises = null;
        
        if (typeAutorisation === 'filiere') {
            filieres_autorisees = [];
            document.querySelectorAll('#filieresCheckboxes input:checked').forEach(cb => {
                filieres_autorisees.push(parseInt(cb.value));
            });
            
            if (filieres_autorisees.length === 0) {
                UIHelpers.showError('Veuillez s√©lectionner au moins une fili√®re');
                return;
            }
        }
        
        if (typeAutorisation === 'niveau') {
            niveaux_autorises = [];
            document.querySelectorAll('input[name="niveau"]:checked').forEach(cb => {
                niveaux_autorises.push(cb.value);
            });
            
            if (niveaux_autorises.length === 0) {
                UIHelpers.showError('Veuillez s√©lectionner au moins un niveau');
                return;
            }
        }
        
        await apiClient.request('/admin/inscription/config-autorisations', {
            method: 'POST',
            body: JSON.stringify({
                type_autorisation: typeAutorisation,
                filieres_autorisees: filieres_autorisees,
                niveaux_autorises: niveaux_autorises
            })
        });
        
        UIHelpers.showSuccess('Configuration enregistr√©e avec succ√®s');
        
    } catch (error) {
        console.error('Erreur configuration:', error);
        UIHelpers.showError('Erreur lors de la configuration');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Toggle des champs selon le type d'autorisation
function toggleAutorisationFields() {
    const type = document.getElementById('typeAutorisation').value;
    
    document.getElementById('filieresField').style.display = type === 'filiere' ? 'block' : 'none';
    document.getElementById('niveauxField').style.display = type === 'niveau' ? 'block' : 'none';
}

// Charger les fili√®res pour les filtres
async function chargerFilieresFiltre() {
    try {
        const response = await apiClient.getFilieres();
        const select = document.getElementById('filtreFiliere');
        const checkboxContainer = document.getElementById('filieresCheckboxes');
        
        select.innerHTML = '<option value="">Toutes</option>';
        checkboxContainer.innerHTML = '';
        
        if (response.filieres) {
            response.filieres.forEach(filiere => {
                // Pour le select de filtre
                const option = document.createElement('option');
                option.value = filiere.id;
                option.textContent = `${filiere.nom} - ${filiere.faculte_libelle}`;
                select.appendChild(option);
                
                // Pour les checkboxes de configuration
                const div = document.createElement('div');
                div.innerHTML = `
                    <label style="display: flex; align-items: center; padding: 5px;">
                        <input type="checkbox" value="${filiere.id}" style="margin-right: 8px;">
                        ${filiere.nom} - ${filiere.faculte_libelle}
                    </label>
                `;
                checkboxContainer.appendChild(div);
            });
        }
    } catch (error) {
        console.error('Erreur chargement fili√®res:', error);
    }
}

// Exporter la liste des √©tudiants
async function exporterEtudiants() {
    try {
        UIHelpers.showLoading(true);
        
        const type = document.getElementById('filtreType').value;
        const filiere_id = document.getElementById('filtreFiliere').value;
        const niveau = document.getElementById('filtreNiveau').value;
        
        const params = new URLSearchParams();
        if (type) params.append('type', type);
        if (filiere_id) params.append('filiere_id', filiere_id);
        if (niveau) params.append('niveau', niveau);
        
        // Cr√©er CSV
        const csv = ['Matricule,Num√©ro Dossier,Nom,Pr√©nom,Email,T√©l√©phone,Type,Fili√®re,Niveau,Autoris√©'];
        
        etudiantsData.forEach(e => {
            const autorise = e.autorise_annee !== null ? e.autorise_annee : e.autorise_inscription;
            csv.push([
                e.matricule || '',
                e.numero_dossier || '',
                e.nom,
                e.prenom,
                e.email,
                e.telephone,
                e.type,
                e.filiere_nom || '',
                e.niveau || '',
                autorise ? 'Oui' : 'Non'
            ].join(','));
        });
        
        const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `Etudiants_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        UIHelpers.showSuccess('Export t√©l√©charg√© avec succ√®s');
        
    } catch (error) {
        console.error('Erreur export:', error);
        UIHelpers.showError('Erreur lors de l\'export');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', async function() {
    // Charger les fili√®res pour les filtres
    await chargerFilieresFiltre();
    
    // Si on est sur la page de gestion des inscriptions
    if (window.location.hash === '#gestionInscriptions') {
        await chargerEtudiantsAutorises();
    }
});

// Configurer les inscriptions
async function configurerInscriptions(event) {
    event.preventDefault();
    
    try {
        UIHelpers.showLoading(true);
        
        const ouvert = document.getElementById('inscriptionsOuvertes').checked;
        const dateOuverture = document.getElementById('dateOuvertureInscription').value || null;
        const dateFermeture = document.getElementById('dateFermetureInscription').value || null;
        
        await apiClient.toggleInscriptions(ouvert, {
            date_ouverture: dateOuverture,
            date_fermeture: dateFermeture
        });
        
        UIHelpers.showSuccess(`Inscriptions ${ouvert ? 'ouvertes' : 'ferm√©es'}`);
        
    } catch (error) {
        console.error('Erreur configuration:', error);
        UIHelpers.showError('Erreur lors de la configuration');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Importer les √©tudiants autoris√©s
async function importerEtudiantsAutorises(input) {
    const file = input.files[0];
    if (!file) return;
    
    try {
        UIHelpers.showLoading(true);
        
        const response = await apiClient.importerEtudiantsAutorises(file);
        
        if (response.success) {
            UIHelpers.showSuccess(`${response.imported} √©tudiant(s) autoris√©(s)`);
            
            if (response.errors && response.errors.length > 0) {
                console.warn('Erreurs d\'import:', response.errors);
                alert(`Import termin√© avec ${response.errors.length} erreur(s). Consultez la console pour les d√©tails.`);
            }
        }
        
    } catch (error) {
        console.error('Erreur import:', error);
        UIHelpers.showError('Erreur lors de l\'import');
    } finally {
        UIHelpers.showLoading(false);
        input.value = '';
    }
}

// Exporter les inscriptions
async function exporterInscriptions(statut = null) {
    try {
        UIHelpers.showLoading(true);
        
        const filtre = {};
        if (statut) filtre.statut = statut;
        
        await apiClient.exporterInscriptions(filtre);
        
        UIHelpers.showSuccess('Export t√©l√©charg√© avec succ√®s');
        
    } catch (error) {
        console.error('Erreur export:', error);
        UIHelpers.showError('Erreur lors de l\'export');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Charger la configuration au chargement de la page
async function chargerConfigInscriptions() {
    try {
        const response = await apiClient.getStatutInscriptions();
        
        if (response.config) {
            document.getElementById('inscriptionsOuvertes').checked = response.config.ouvert;
            
            if (response.config.date_ouverture) {
                const date = new Date(response.config.date_ouverture);
                document.getElementById('dateOuvertureInscription').value = date.toISOString().slice(0, 16);
            }
            
            if (response.config.date_fermeture) {
                const date = new Date(response.config.date_fermeture);
                document.getElementById('dateFermetureInscription').value = date.toISOString().slice(0, 16);
            }
        }
    } catch (error) {
        console.error('Erreur chargement config:', error);
    }
}

// =================== FONCTIONS AM√âLIOR√âES POUR LES STATISTIQUES ===================

// Variables globales pour les graphiques

let currentCharts = {};
let currentStatistics = {};

// Configuration des couleurs pour les graphiques
const COLORS = {
    primary: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe'],
    success: ['#28a745', '#20c997', '#17a2b8', '#6f42c1', '#e83e8c', '#fd7e14'],
    gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
};

// =================== GESTION DES ONGLETS STATISTIQUES ===================
function ouvrirOngletStats(event, ongletNom) {
    // Masquer tous les contenus d'onglets
    document.querySelectorAll('.stats-tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Retirer la classe active de tous les boutons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Afficher l'onglet s√©lectionn√©
    document.getElementById(`stats-${ongletNom}`).classList.add('active');
    event.target.classList.add('active');
    
    // Charger les donn√©es de l'onglet
    switch(ongletNom) {
        case 'tableau-bord':
            chargerTableauBordStats();
            break;
        case 'genre':
            chargerStatsGenreAvancees();
            break;
        case 'type-bac':
            chargerStatsTypeBacAvancees();
            break;
        case 'facultes':
            chargerStatsFacultesAvancees();
            break;
        case 'filieres':
            chargerStatsFilieresAvancees();
            break;
        case 'temporelles':
            chargerStatsTemporellesAvancees();
            break;
        case 'avancees':
            chargerAnalysesAvancees();
            break;
    }
}

// =================== FONCTIONS UTILITAIRES POUR LES GRAPHIQUES ===================

// Fonction pour d√©truire un graphique existant
function destroyChart(chartId) {
    if (currentCharts[chartId]) {
        currentCharts[chartId].destroy();
        delete currentCharts[chartId];
    }
}

// Graphique en secteurs (camembert)
function createPieChart(canvasId, data, options = {}) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return null;

    destroyChart(canvasId);

    const config = {
        type: 'pie',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            ...options
        }
    };

    const chart = new Chart(ctx, config);
    currentCharts[canvasId] = chart;
    return chart;
}

// Fonction globale pour l'export Excel des approuv√©s
async function exporterApprouvesExcel() {
    try {
        console.log('üìä Lancement export Excel approuv√©s...');
        UIHelpers.showLoading(true);
        
        await apiClient.exportApprouvesExcel();
        
        UIHelpers.showSuccess('Export Excel t√©l√©charg√© avec succ√®s !');
        
    } catch (error) {
        console.error('‚ùå Erreur export Excel approuv√©s:', error);
        UIHelpers.showError('Erreur lors de l\'export Excel: ' + error.message);
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Graphique en barres
function createBarChart(canvasId, data, options = {}) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return null;

    destroyChart(canvasId);

    const config = {
        type: 'bar',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            ...options
        }
    };

    const chart = new Chart(ctx, config);
    currentCharts[canvasId] = chart;
    return chart;
}

// Graphique en barres horizontales
function createHorizontalBarChart(canvasId, data, options = {}) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return null;

    destroyChart(canvasId);

    const config = {
        type: 'bar',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            ...options
        }
    };

    const chart = new Chart(ctx, config);
    currentCharts[canvasId] = chart;
    return chart;
}

// Graphique lin√©aire
function createLineChart(canvasId, data, options = {}) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return null;

    destroyChart(canvasId);

    const config = {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            ...options
        }
    };

    const chart = new Chart(ctx, config);
    currentCharts[canvasId] = chart;
    return chart;
}

// Graphique en anneau (doughnut)
function createDoughnutChart(canvasId, data, options = {}) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return null;

    destroyChart(canvasId);

    const config = {
        type: 'doughnut',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            ...options
        }
    };

    const chart = new Chart(ctx, config);
    currentCharts[canvasId] = chart;
    return chart;
}

// Graphique mixte (barres + ligne)
function createMixedChart(canvasId, data, options = {}) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return null;

    destroyChart(canvasId);

    const config = {
        type: 'bar',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            ...options
        }
    };

    const chart = new Chart(ctx, config);
    currentCharts[canvasId] = chart;
    return chart;
}

// =================== FONCTIONS D'EXPORT ET IMPRESSION ===================

// Exporter toutes les statistiques en PDF
async function exporterToutesStatistiques() {
    try {
        UIHelpers.showLoading(true);
        
        // Cr√©er un PDF complet avec jsPDF
        const doc = new window.jsPDF('p', 'mm', 'a4');
        
        // Configuration
        let y = 20;
        const margin = 20;
        const pageWidth = doc.internal.pageSize.width;
        
        // En-t√™te
        doc.setFontSize(20);
        doc.setFont('helvetica', 'bold');
        doc.text('Rapport Statistiques Complet', pageWidth/2, y, { align: 'center' });
        y += 15;
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}`, pageWidth/2, y, { align: 'center' });
        y += 20;
        
        // R√©sum√© g√©n√©ral
        const general = currentStatistics.general || {};
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('R√©sum√© G√©n√©ral', margin, y);
        y += 10;
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Total candidatures: ${general.total_candidatures || 0}`, margin, y);
        y += 6;
        doc.text(`Candidatures approuv√©es: ${general.approuves || 0}`, margin, y);
        y += 6;
        doc.text(`R√©partition genre - Hommes: ${general.hommes || 0}, Femmes: ${general.femmes || 0}`, margin, y);
        y += 15;
        
        // Ajouter d'autres sections...
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('Analyses D√©taill√©es', margin, y);
        y += 10;
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('‚Ä¢ R√©partition par genre et performances', margin, y);
        y += 6;
        doc.text('‚Ä¢ Analyse par type de baccalaur√©at', margin, y);
        y += 6;
        doc.text('‚Ä¢ R√©partition par facult√© et fili√®re', margin, y);
        y += 6;
        doc.text('‚Ä¢ √âvolution temporelle des candidatures', margin, y);
        y += 15;
        
        // Footer
        doc.setFontSize(8);
        doc.text(`Rapport g√©n√©r√© par EduFile - ${new Date().toLocaleString('fr-FR')}`, 
                 pageWidth/2, doc.internal.pageSize.height - 10, { align: 'center' });
        
        // Sauvegarder
        doc.save(`Statistiques_EduFile_${new Date().toISOString().split('T')[0]}.pdf`);
        
        UIHelpers.showSuccess('Rapport PDF g√©n√©r√© avec succ√®s!');
        
    } catch (error) {
        console.error('Erreur export PDF:', error);
        UIHelpers.showError('Erreur lors de la g√©n√©ration du PDF');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Exporter les statistiques de la section actuelle
function exporterStatistiquesActuelles() {
    const activeTab = document.querySelector('.stats-tab-content.active');
    if (!activeTab) return;
    
    const tabId = activeTab.id.replace('stats-', '');
    
    try {
        // Export en CSV selon la section active
        let csvData = '';
        let filename = `Statistiques_${tabId}_${new Date().toISOString().split('T')[0]}.csv`;
        
        switch(tabId) {
            case 'genre':
                csvData = exporterCSVGenre();
                break;
            case 'type-bac':
                csvData = exporterCSVTypeBac();
                break;
            case 'filieres':
                csvData = exporterCSVFilieres();
                break;
            case 'facultes':
                csvData = exporterCSVFacultes();
                break;
            default:
                csvData = exporterCSVGeneral();
                filename = `Statistiques_General_${new Date().toISOString().split('T')[0]}.csv`;
        }
        
        // T√©l√©charger le fichier CSV
        const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        UIHelpers.showSuccess('Export CSV g√©n√©r√© avec succ√®s!');
        
    } catch (error) {
        console.error('Erreur export CSV:', error);
        UIHelpers.showError('Erreur lors de l\'export CSV');
    }
}

// Fonctions d'export CSV sp√©cifiques
function exporterCSVGenre() {
    const headers = ['Genre', 'Total_Candidatures', 'Approuvees', 'Rejetees', 'En_Attente', 'Taux_Approbation'];
    let csv = headers.join(',') + '\n';
    
    // R√©cup√©rer les donn√©es du tableau
    const rows = document.querySelectorAll('#detailsTableauGenre tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length > 0) {
            const rowData = Array.from(cells).map(cell => 
                cell.textContent.replace(/,/g, ';').trim()
            );
            csv += rowData.join(',') + '\n';
        }
    });
    
    return csv;
}

function exporterCSVTypeBac() {
    const headers = ['Type_Bac', 'Total_Candidatures', 'Approuvees', 'Taux_Approbation'];
    let csv = headers.join(',') + '\n';
    
    // Utiliser les donn√©es stock√©es en m√©moire
    if (currentStatistics.typeBac) {
        currentStatistics.typeBac.forEach(stat => {
            const tauxApprobation = ((parseInt(stat.approuves) / parseInt(stat.nombre)) * 100).toFixed(1);
            csv += `${stat.type_bac},${stat.nombre},${stat.approuves},${tauxApprobation}%\n`;
        });
    }
    
    return csv;
}

function exporterCSVFilieres() {
    const headers = ['Filiere', 'Total_Candidatures', 'Approuvees', 'Taux_Approbation'];
    let csv = headers.join(',') + '\n';
    
    if (currentStatistics.filieres) {
        currentStatistics.filieres.forEach(stat => {
            const tauxApprobation = ((parseInt(stat.approuves) / parseInt(stat.nombre)) * 100).toFixed(1);
            csv += `${stat.filiere},${stat.nombre},${stat.approuves},${tauxApprobation}%\n`;
        });
    }
    
    return csv;
}

function exporterCSVFacultes() {
    const headers = ['Faculte', 'Premier_Choix', 'Deuxieme_Choix', 'Troisieme_Choix', 'Total'];
    let csv = headers.join(',') + '\n';
    
    if (currentStatistics.facultes) {
        currentStatistics.facultes.forEach(stat => {
            const total = parseInt(stat.premier_choix) + parseInt(stat.deuxieme_choix) + parseInt(stat.troisieme_choix);
            csv += `${stat.faculte},${stat.premier_choix},${stat.deuxieme_choix},${stat.troisieme_choix},${total}\n`;
        });
    }
    
    return csv;
}

function exporterCSVGeneral() {
    const headers = ['Indicateur', 'Valeur'];
    let csv = headers.join(',') + '\n';
    
    const general = currentStatistics.general || {};
    csv += `Total_Candidatures,${general.total_candidatures || 0}\n`;
    csv += `Candidatures_Approuvees,${general.approuves || 0}\n`;
    csv += `Hommes,${general.hommes || 0}\n`;
    csv += `Femmes,${general.femmes || 0}\n`;
    csv += `Taux_Approbation,${general.total_candidatures > 0 ? ((general.approuves / general.total_candidatures) * 100).toFixed(1) : 0}%\n`;
    
    return csv;
}

// Imprimer le rapport
function imprimerRapport() {
    const activeTab = document.querySelector('.stats-tab-content.active');
    if (!activeTab) return;
    
    // Cr√©er une nouvelle fen√™tre pour l'impression
    const printWindow = window.open('', '_blank');
    
    // HTML pour l'impression
    const printHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Rapport Statistiques EduFile</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    margin: 20px; 
                    line-height: 1.6;
                }
                h1, h2, h3 { 
                    color: #667eea; 
                    page-break-after: avoid;
                }
                table { 
                    border-collapse: collapse; 
                    width: 100%; 
                    margin: 20px 0;
                }
                th, td { 
                    border: 1px solid #ddd; 
                    padding: 8px; 
                    text-align: left;
                }
                th { 
                    background-color: #667eea; 
                    color: white;
                }
                .no-print { 
                    display: none;
                }
                .print-header {
                    text-align: center;
                    border-bottom: 2px solid #667eea;
                    padding-bottom: 20px;
                    margin-bottom: 30px;
                }
                .stat-summary {
                    background: #f8f9fa;
                    padding: 15px;
                    border-radius: 5px;
                    margin: 15px 0;
                }
                @media print {
                    body { margin: 0; }
                    .no-print { display: none !important; }
                }
            </style>
        </head>
        <body>
            <div class="print-header">
                <h1>Universit√© Djibo Hamani de Tahoua</h1>
                <h2>Rapport Statistiques EduFile</h2>
                <p>G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}</p>
            </div>
            
            <div class="stat-summary">
                <h3>R√©sum√© G√©n√©ral</h3>
                <p><strong>Total candidatures:</strong> ${document.getElementById('statTotalCandidatures')?.textContent || 0}</p>
                <p><strong>Candidatures approuv√©es:</strong> ${document.getElementById('statApprouvees')?.textContent || 0}</p>
                <p><strong>R√©partition genre:</strong> ${document.getElementById('statHommes')?.textContent || 0} hommes, ${document.getElementById('statFemmes')?.textContent || 0} femmes</p>
            </div>
            
            ${activeTab.innerHTML.replace(/canvas/g, 'div').replace(/onclick="[^"]*"/g, '')}
            
            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; font-size: 12px; color: #666;">
                <p>Rapport g√©n√©r√© automatiquement par le syst√®me EduFile</p>
                <p>Universit√© Djibo Hamani de Tahoua - Service Central de la Scolarit√©</p>
            </div>
        </body>
        </html>
    `;
    
    printWindow.document.write(printHTML);
    printWindow.document.close();
    
    // Attendre le chargement puis imprimer
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 1000);
}

// =================== FONCTIONS D'INITIALISATION ===================

// Initialiser les statistiques au chargement de la page
function initialiserStatistiques() {
    console.log('üöÄ Initialisation module statistiques...');
    
    // V√©rifier les d√©pendances
    if (typeof Chart === 'undefined') {
        console.error('‚ùå Chart.js non charg√©');
        UIHelpers.showError('Erreur: Chart.js non charg√©');
        return false;
    }
    
    if (typeof apiClient === 'undefined') {
        console.error('‚ùå ApiClient non disponible');
        return false;
    }
    
    // Configuration Chart.js
    Chart.defaults.font.family = 'Arial, sans-serif';
    Chart.defaults.color = '#666';
    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;
    
    console.log('‚úÖ Module statistiques initialis√©');
    return true;
}

// Auto-initialisation avec retry
let initRetries = 0;
const maxRetries = 5;

function tentativeInitialisation() {
    if (initialiserStatistiques()) {
        console.log('‚úÖ Initialisation r√©ussie');
        
        // Si on est sur la page stats et connect√© en admin
        if (window.location.hash === '#statistiques' && 
            apiClient?.currentUser?.role === 'admin') {
            setTimeout(() => {
                console.log('üìä Chargement automatique du tableau de bord');
                chargerTableauBordStats();
            }, 1000);
        }
    } else {
        initRetries++;
        if (initRetries < maxRetries) {
            console.log(`üîÑ Nouvelle tentative (${initRetries}/${maxRetries}) dans 2s...`);
            setTimeout(tentativeInitialisation, 2000);
        } else {
            console.error('‚ùå √âchec initialisation apr√®s', maxRetries, 'tentatives');
        }
    }
}

// D√©marrer l'initialisation
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(tentativeInitialisation, 1000);
    });
} else {
    setTimeout(tentativeInitialisation, 1000);
}

console.log('üìä Module statistiques charg√©');
// Nettoyer tous les graphiques
function nettoyerTousLesGraphiques() {
    Object.keys(currentCharts).forEach(chartId => {
        destroyChart(chartId);
    });
    currentStatistics = {};
    console.log('Tous les graphiques ont √©t√© nettoy√©s');
}

// Sauvegarder les statistiques en cache pour l'export

// Dans la fonction exporterStatistiquesActuelles()
async function exporterStatistiquesActuelles() {
    const activeTab = document.querySelector('.stats-tab-content.active');
    if (!activeTab) return;
    
    const tabId = activeTab.id.replace('stats-', '');
    
    try {
        UIHelpers.showLoading(true);
        
        switch(tabId) {
            case 'facultes':
                // Export avec toutes les infos pour cette section
                await apiClient.exportBySection('par-faculte');
                break;
            case 'genre':
                await apiClient.exportBySection('par-genre');
                break;
            default:
                await apiClient.exportStatistics(tabId);
        }
        
        UIHelpers.showSuccess('Export t√©l√©charg√© avec succ√®s!');
    } catch (error) {
        console.error('Erreur export:', error);
        UIHelpers.showError('Erreur lors de l\'export');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Nouvelle fonction pour export complet
async function exporterToutesLesCandidatures() {
    try {
        UIHelpers.showLoading(true);
        await apiClient.exportCandidaturesComplete();
        UIHelpers.showSuccess('Export complet t√©l√©charg√©!');
    } catch (error) {
        console.error('Erreur:', error);
        UIHelpers.showError('Erreur lors de l\'export complet');
    } finally {
        UIHelpers.showLoading(false);
    }
}
// =================== MISE √Ä JOUR DE LA FONCTION PRINCIPALE ===================

// Modifier la fonction chargerStatistiques existante
const originalChargerStatistiques = window.chargerStatistiques;
window.chargerStatistiques = function() {
    // Appeler l'ancienne fonction pour la compatibilit√©
    if (originalChargerStatistiques) {
        originalChargerStatistiques.call(this);
    }
    
    // Initialiser les nouvelles statistiques
    setTimeout(() => {
        chargerTableauBordStats();
    }, 100);
};

// Auto-initialisation
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        initialiserStatistiques();
    }, 1000);
});

// Export pour utilisation globale
window.statistiquesAvancees = {
    chargerTableauBordStats,
    chargerStatsGenreAvancees,
    chargerStatsTypeBacAvancees,
    chargerStatsFacultesAvancees,
    chargerStatsFilieresAvancees,
    chargerStatsTemporellesAvancees,
    chargerAnalysesAvancees,
    ouvrirOngletStats,
    exporterToutesStatistiques,
    exporterStatistiquesActuelles,
    imprimerRapport,
    nettoyerTousLesGraphiques
};

console.log('‚úÖ Module statistiques avanc√©es charg√© avec succ√®s');

// =================== TABLEAU DE BORD PRINCIPAL ===================
async function chargerTableauBordStats() {
    try {
        console.log('üéØ D√©but chargement tableau de bord...');
        
        // V√©rifier que l'utilisateur est admin
        if (!apiClient.currentUser || apiClient.currentUser.role !== 'admin') {
            console.error('‚ùå Acc√®s non autoris√© - pas admin');
            UIHelpers.showError('Acc√®s non autoris√©');
            return;
        }
        
        // V√©rifier que Chart.js est disponible
        if (typeof Chart === 'undefined') {
            console.error('‚ùå Chart.js non disponible');
            UIHelpers.showError('Chart.js non charg√©');
            return;
        }
        
        UIHelpers.showLoading(true);
        
        // Charger les donn√©es avec gestion d'erreur robuste
        let dashboardData;
        try {
            dashboardData = await apiClient.getStatsDashboard();
        } catch (error) {
            console.error('‚ùå Erreur API dashboard:', error);
            throw new Error('Impossible de r√©cup√©rer les donn√©es du serveur: ' + error.message);
        }
        
        if (!dashboardData || !dashboardData.success) {
            throw new Error('R√©ponse invalide du serveur');
        }
        
        console.log('‚úÖ Donn√©es re√ßues:', dashboardData);
        
        const { general, topFilieres, repartitionBac, evolution } = dashboardData;
        
        // 1. Mise √† jour des cartes de r√©sum√© avec v√©rification
        const elements = {
            'statTotalCandidatures': general?.total_candidatures || 0,
            'statApprouvees': general?.approuves || 0,
            'statHommes': general?.hommes || 0,
            'statFemmes': general?.femmes || 0
        };
        
        for (const [elementId, value] of Object.entries(elements)) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
                console.log(`‚úÖ ${elementId} mis √† jour: ${value}`);
            } else {
                console.warn(`‚ö†Ô∏è √âl√©ment ${elementId} non trouv√©`);
            }
        }
        
        // 2. Graphique Top Fili√®res (si donn√©es disponibles)
        if (topFilieres && topFilieres.length > 0) {
            const canvasElement = document.getElementById('chartTopFilieres');
            if (canvasElement) {
                try {
                    // D√©truire le graphique existant
                    if (currentCharts.chartTopFilieres) {
                        currentCharts.chartTopFilieres.destroy();
                        delete currentCharts.chartTopFilieres;
                    }
                    
                    const ctx = canvasElement.getContext('2d');
                    currentCharts.chartTopFilieres = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: topFilieres.map(f => f.filiere),
                            datasets: [{
                                data: topFilieres.map(f => f.nombre),
                                backgroundColor: [
                                    '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe'
                                ],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                    console.log('‚úÖ Graphique fili√®res cr√©√©');
                } catch (chartError) {
                    console.error('‚ùå Erreur cr√©ation graphique fili√®res:', chartError);
                }
            } else {
                console.warn('‚ö†Ô∏è Canvas chartTopFilieres non trouv√©');
            }
        }
        
        // 3. Graphique R√©partition Bac
        if (repartitionBac && repartitionBac.length > 0) {
            const canvasElement = document.getElementById('chartRepartitionBac');
            if (canvasElement) {
                try {
                    if (currentCharts.chartRepartitionBac) {
                        currentCharts.chartRepartitionBac.destroy();
                        delete currentCharts.chartRepartitionBac;
                    }
                    
                    const ctx = canvasElement.getContext('2d');
                    currentCharts.chartRepartitionBac = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: repartitionBac.map(b => b.type_bac),
                            datasets: [{
                                label: 'Candidatures',
                                data: repartitionBac.map(b => b.nombre),
                                backgroundColor: '#28a745',
                                borderColor: '#1e7e34',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { 
                                    beginAtZero: true,
                                    ticks: { precision: 0 }
                                }
                            }
                        }
                    });
                    console.log('‚úÖ Graphique bac cr√©√©');
                } catch (chartError) {
                    console.error('‚ùå Erreur cr√©ation graphique bac:', chartError);
                }
            }
        }
        
        // 4. Graphique √âvolution
        if (evolution && evolution.length > 0) {
            const canvasElement = document.getElementById('chartEvolution');
            if (canvasElement) {
                try {
                    if (currentCharts.chartEvolution) {
                        currentCharts.chartEvolution.destroy();
                        delete currentCharts.chartEvolution;
                    }
                    
                    const ctx = canvasElement.getContext('2d');
                    currentCharts.chartEvolution = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: evolution.map(e => e.mois),
                            datasets: [{
                                label: 'Candidatures',
                                data: evolution.map(e => e.candidatures),
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { 
                                    beginAtZero: true,
                                    ticks: { precision: 0 }
                                }
                            }
                        }
                    });
                    console.log('‚úÖ Graphique √©volution cr√©√©');
                } catch (chartError) {
                    console.error('‚ùå Erreur cr√©ation graphique √©volution:', chartError);
                }
            }
        }
        
        console.log('üéâ Tableau de bord charg√© avec succ√®s');
        
    } catch (error) {
        console.error('‚ùå Erreur compl√®te tableau de bord:', error);
        UIHelpers.showError('Erreur lors du chargement des statistiques: ' + error.message);
        
        // Afficher un message d'erreur dans les √©l√©ments
        ['statTotalCandidatures', 'statApprouvees', 'statHommes', 'statFemmes'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = 'Erreur';
                element.style.color = '#dc3545';
            }
        });
        
    } finally {
        UIHelpers.showLoading(false);
    }
}
window.exporterParFaculte = async function() {
    try {
        UIHelpers.showLoading(true);
        await apiClient.exporterParFaculte();
        UIHelpers.showSuccess('Export par facult√© t√©l√©charg√© !');
    } catch (error) {
        console.error('Erreur:', error);
        UIHelpers.showError('Erreur lors de l\'export par facult√©');
    } finally {
        UIHelpers.showLoading(false);
    }
};

window.exporterParGenre = async function() {
    try {
        UIHelpers.showLoading(true);
        await apiClient.exporterParGenre();
        UIHelpers.showSuccess('Export par genre t√©l√©charg√© !');
    } catch (error) {
        console.error('Erreur:', error);
        UIHelpers.showError('Erreur lors de l\'export par genre');
    } finally {
        UIHelpers.showLoading(false);
    }
};

window.exporterParStatut = async function() {
    try {
        UIHelpers.showLoading(true);
        await apiClient.exporterParStatut('en-attente'); // Par d√©faut en-attente
        UIHelpers.showSuccess('Export par statut t√©l√©charg√© !');
    } catch (error) {
        console.error('Erreur:', error);
        UIHelpers.showError('Erreur lors de l\'export par statut');
    } finally {
        UIHelpers.showLoading(false);
    }
};

console.log('‚úÖ Corrections pour les exports par section appliqu√©es');

function tentativeInitialisation() {
    if (initialiserStatistiques()) {
        console.log('‚úÖ Initialisation r√©ussie');
        
        // Si on est sur la page stats et connect√© en admin
        if (window.location.hash === '#statistiques' && 
            apiClient?.currentUser?.role === 'admin') {
            setTimeout(() => {
                console.log('üìä Chargement automatique du tableau de bord');
                chargerTableauBordStats();
            }, 1000);
        }
    } else {
        initRetries++;
        if (initRetries < maxRetries) {
            console.log(`üîÑ Nouvelle tentative (${initRetries}/${maxRetries}) dans 2s...`);
            setTimeout(tentativeInitialisation, 2000);
        } else {
            console.error('‚ùå √âchec initialisation apr√®s', maxRetries, 'tentatives');
        }
    }
}

// D√©marrer l'initialisation
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(tentativeInitialisation, 1000);
    });
} else {
    setTimeout(tentativeInitialisation, 1000);
}

console.log('üìä Module statistiques charg√©');
// Nettoyer tous les graphiques
function nettoyerTousLesGraphiques() {
    Object.keys(currentCharts).forEach(chartId => {
        destroyChart(chartId);
    });
    currentStatistics = {};
    console.log('Tous les graphiques ont √©t√© nettoy√©s');
}

// Sauvegarder les statistiques en cache pour l'export
function sauvegarderStatistiques(type, data) {
    currentStatistics[type] = data;
}

// =================== NOUVELLES M√âTHODES API POUR LES STATISTIQUES ===================

// Ajouter ces m√©thodes √† la classe ApiClient existante
if (typeof apiClient !== 'undefined') {
    // Statistiques par genre
    apiClient.getStatsByGenre = async function() {
        const data = await this.request('/admin/stats/genre');
        sauvegarderStatistiques('genre', data.stats);
        return data;
    };

    // Statistiques par fili√®res
    apiClient.getStatsByFilieres = async function() {
        const data = await this.request('/admin/stats/filieres');
        sauvegarderStatistiques('filieres', data.stats);
        return data;
    };

    // Statistiques par facult√©s
    apiClient.getStatsByFacultes = async function() {
        const data = await this.request('/admin/stats/facultes-candidatures');
        sauvegarderStatistiques('facultes', data.stats);
        return data;
    };

    // Statistiques par type de bac
    apiClient.getStatsByTypeBac = async function() {
        const data = await this.request('/admin/stats/type-bac');
        sauvegarderStatistiques('typeBac', data.stats);
        return data;
    };

    // Statistiques par lieu d'obtention
    apiClient.getStatsByLieuObtention = async function() {
        return this.request('/admin/stats/lieu-obtention');
    };

    // Statistiques temporelles
    apiClient.getStatsTemporelles = async function() {
        return this.request('/admin/stats/temporelles');
    };

    // Statistiques crois√©es genre √ó type de bac
    apiClient.getStatsGenreBac = async function() {
        return this.request('/admin/stats/genre-bac');
    };

    // Statistiques mentions par fili√®res
    apiClient.getStatsMentionsFilieres = async function() {
        return this.request('/admin/stats/mentions-filieres');
    };

    // Tableau de bord complet
    apiClient.getStatsDashboard = async function() {
        const data = await this.request('/admin/stats/dashboard');
        sauvegarderStatistiques('general', data.general);
        return data;
    };

    // Export des statistiques
    apiClient.exportStatistics = async function(type) {
        const response = await fetch(`${API_BASE_URL}/admin/export/statistiques/${type}`, {
            headers: {
                Authorization: `Bearer ${this.token}`
            }
        });

        if (!response.ok) {
            throw new Error('Erreur lors de l\'export');
        }

        const blob = await response.blob();
        const filename = response.headers.get('Content-Disposition')?.split('filename=')[1] || `export_stats_${type}.csv`;
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };
}
// =================== STATISTIQUES PAR GENRE AVANC√âES ===================
async function chargerStatsGenreAvancees() {
    try {
        UIHelpers.showLoading(true);
        
        const response = await apiClient.getStatsByGenre();
        const stats = response.stats || [];
        
        if (stats.length === 0) {
            document.getElementById('stats-genre').innerHTML = '<p class="text-center">Aucune donn√©e disponible</p>';
            return;
        }
        
        // Graphique principal par genre
        const dataGenre = {
            labels: stats.map(s => s.genre === 'masculin' ? 'Hommes' : 'Femmes'),
            datasets: [{
                data: stats.map(s => parseInt(s.nombre)),
                backgroundColor: ['#36A2EB', '#FF6384'],
                borderColor: '#fff',
                borderWidth: 3
            }]
        };
        
        createPieChart('chartGenre', dataGenre, {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { padding: 20 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed} (${percentage}%)`;
                        }
                    }
                }
            }
        });
        
        // Graphique taux d'approbation par genre
        const dataApprobation = {
            labels: stats.map(s => s.genre === 'masculin' ? 'Hommes' : 'Femmes'),
            datasets: [{
                label: 'Taux d\'approbation (%)',
                data: stats.map(s => ((parseInt(s.approuves) / parseInt(s.nombre)) * 100).toFixed(1)),
                backgroundColor: COLORS.success,
                borderColor: '#fff',
                borderWidth: 2
            }]
        };
        
        createBarChart('chartGenreApprobation', dataApprobation, {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        });
        
        // Tableau d√©taill√©
        const tableauBody = document.getElementById('detailsTableauGenre');
        tableauBody.innerHTML = '';
        
        stats.forEach(stat => {
            const total = parseInt(stat.nombre);
            const approuves = parseInt(stat.approuves);
            const rejetes = parseInt(stat.rejetes || 0);
            const enAttente = parseInt(stat.en_attente || 0);
            const tauxApprobation = ((approuves / total) * 100).toFixed(1);
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${stat.genre === 'masculin' ? 'Hommes' : 'Femmes'}</strong></td>
                <td>${total}</td>
                <td><span class="status-badge status-approved">${approuves}</span></td>
                <td><span class="status-badge status-rejected">${rejetes}</span></td>
                <td><span class="status-badge status-pending">${enAttente}</span></td>
                <td><strong>${tauxApprobation}%</strong></td>
            `;
            tableauBody.appendChild(row);
        });
        
        // Insights pour les d√©tails
        const detailsDiv = document.getElementById('detailsGenre');
        const hommes = stats.find(s => s.genre === 'masculin') || {};
        const femmes = stats.find(s => s.genre === 'feminin') || {};
        
        detailsDiv.innerHTML = `
            <div class="stat-detail">
                <h4>Analyse Comparative</h4>
                <p><strong>Genre dominant:</strong> ${parseInt(hommes.nombre || 0) > parseInt(femmes.nombre || 0) ? 'Masculin' : 'F√©minin'}</p>
                <p><strong>√âcart:</strong> ${Math.abs(parseInt(hommes.nombre || 0) - parseInt(femmes.nombre || 0))} candidatures</p>
                <p><strong>Taux de parit√©:</strong> ${((Math.min(parseInt(hommes.nombre || 0), parseInt(femmes.nombre || 0)) / Math.max(parseInt(hommes.nombre || 0), parseInt(femmes.nombre || 0))) * 100).toFixed(1)}%</p>
            </div>
        `;
        
    } catch (error) {
        console.error('Erreur chargement stats genre:', error);
        UIHelpers.showError('Erreur lors du chargement des statistiques par genre');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// =================== STATISTIQUES PAR TYPE DE BAC AVANC√âES ===================
async function chargerStatsTypeBacAvancees() {
    try {
        UIHelpers.showLoading(true);
        
        const response = await apiClient.getStatsByTypeBac();
        const stats = response.stats || [];
        
        if (stats.length === 0) return;
        
        // Distribution par type de bac
        const dataTypeBac = {
            labels: stats.map(s => s.type_bac),
            datasets: [{
                data: stats.map(s => parseInt(s.nombre)),
                backgroundColor: COLORS.primary,
                borderColor: '#fff',
                borderWidth: 2
            }]
        };
        
        createPieChart('chartTypeBac', dataTypeBac, {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { padding: 15 }
                }
            }
        });
        
        // Performance par type de bac
        const dataPerformance = {
            labels: stats.map(s => s.type_bac),
            datasets: [{
                label: 'Total candidatures',
                data: stats.map(s => parseInt(s.nombre)),
                backgroundColor: COLORS.primary[0],
                yAxisID: 'y'
            }, {
                label: 'Taux d\'approbation (%)',
                data: stats.map(s => ((parseInt(s.approuves) / parseInt(s.nombre)) * 100).toFixed(1)),
                backgroundColor: COLORS.success[0],
                yAxisID: 'y1',
                type: 'line',
                borderColor: COLORS.success[0],
                tension: 0.3
            }]
        };
        
        createMixedChart('chartTypeBacPerformance', dataPerformance, {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        });
        
    } catch (error) {
        console.error('Erreur chargement stats type bac:', error);
        UIHelpers.showError('Erreur lors du chargement des statistiques par type de bac');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// =================== STATISTIQUES PAR FACULT√â AVANC√âES ===================
async function chargerStatsFacultesAvancees() {
    try {
        UIHelpers.showLoading(true);
        
        const response = await apiClient.getStatsByFacultes();
        const stats = response.stats || [];
        
        if (stats.length === 0) return;
        
        // Graphique principal des facult√©s
        const dataFacultes = {
            labels: stats.map(s => s.faculte),
            datasets: [{
                label: '1er choix',
                data: stats.map(s => parseInt(s.premier_choix)),
                backgroundColor: COLORS.primary[0],
            }, {
                label: '2√®me choix',
                data: stats.map(s => parseInt(s.deuxieme_choix)),
                backgroundColor: COLORS.primary[1],
            }, {
                label: '3√®me choix',
                data: stats.map(s => parseInt(s.troisieme_choix)),
                backgroundColor: COLORS.primary[2],
            }]
        };
        
        createBarChart('chartFacultes', dataFacultes, {
            responsive: true,
            plugins: {
                legend: { 
                    position: 'top',
                    labels: { padding: 20 }
                }
            },
            scales: {
                x: { stacked: true },
                y: { 
                    stacked: true,
                    beginAtZero: true
                }
            }
        });
        
        // Graphique des pr√©f√©rences de choix
        const totalChoix = stats.reduce((acc, s) => {
            acc.premier += parseInt(s.premier_choix);
            acc.deuxieme += parseInt(s.deuxieme_choix);
            acc.troisieme += parseInt(s.troisieme_choix);
            return acc;
        }, { premier: 0, deuxieme: 0, troisieme: 0 });
        
        const dataChoix = {
            labels: ['1er Choix', '2√®me Choix', '3√®me Choix'],
            datasets: [{
                data: [totalChoix.premier, totalChoix.deuxieme, totalChoix.troisieme],
                backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                borderColor: '#fff',
                borderWidth: 3
            }]
        };
        
        createDoughnutChart('chartChoixFacultes', dataChoix, {
            responsive: true,
            cutout: '50%',
            plugins: {
                legend: { position: 'bottom' }
            }
        });
        
        // D√©tails par facult√©
        const detailsDiv = document.getElementById('detailsFacultes');
        let detailsHtml = '<div class="stat-detail-grid">';
        
        stats.forEach(stat => {
            const total = parseInt(stat.premier_choix) + parseInt(stat.deuxieme_choix) + parseInt(stat.troisieme_choix);
            const tauxPremierChoix = ((parseInt(stat.premier_choix) / total) * 100).toFixed(1);
            
            detailsHtml += `
                <div class="stat-detail">
                    <h4>${stat.faculte}</h4>
                    <p><strong>Total candidatures:</strong> ${total}</p>
                    <p><strong>Attractivit√© (1er choix):</strong> ${tauxPremierChoix}%</p>
                    <p><strong>Approuv√©es:</strong> ${stat.approuves || 0}</p>
                </div>
            `;
        });
        
        detailsHtml += '</div>';
        detailsDiv.innerHTML = detailsHtml;
        
    } catch (error) {
        console.error('Erreur chargement stats facult√©s:', error);
        UIHelpers.showError('Erreur lors du chargement des statistiques par facult√©');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// =================== STATISTIQUES PAR FILI√àRE AVANC√âES ===================
async function chargerStatsFilieresAvancees() {
    try {
        UIHelpers.showLoading(true);
        
        const response = await apiClient.getStatsByFilieres();
        const stats = response.stats || [];
        
        if (stats.length === 0) return;
        
        // Graphique horizontal des fili√®res
        const dataFilieres = {
            labels: stats.map(s => s.filiere.charAt(0).toUpperCase() + s.filiere.slice(1).toLowerCase()),
            datasets: [{
                label: 'Candidatures totales',
                data: stats.map(s => parseInt(s.nombre)),
                backgroundColor: COLORS.primary[0],
                borderColor: COLORS.primary[1],
                borderWidth: 1
            }, {
                label: 'Candidatures approuv√©es',
                data: stats.map(s => parseInt(s.approuves)),
                backgroundColor: COLORS.success[0],
                borderColor: COLORS.success[1],
                borderWidth: 1
            }]
        };
        
        createHorizontalBarChart('chartFilieres', dataFilieres, {
            responsive: true,
            indexAxis: 'y',
            plugins: {
                legend: { 
                    position: 'top',
                    labels: { padding: 20 }
                }
            },
            scales: {
                x: { beginAtZero: true }
            }
        });
        
        // Tableau d√©taill√©
        const tableauBody = document.getElementById('detailsFilieres');
        tableauBody.innerHTML = '';
        
        stats.forEach((stat, index) => {
            const total = parseInt(stat.nombre);
            const approuves = parseInt(stat.approuves);
            const tauxApprobation = ((approuves / total) * 100).toFixed(1);
            const popularite = Math.min(5, Math.ceil((total / stats[0].nombre) * 5)); // √âtoiles de popularit√©
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${stat.filiere}</strong></td>
                <td><span class="stat-badge primary">${total}</span></td>
                <td><span class="stat-badge success">${approuves}</span></td>
                <td><strong>${tauxApprobation}%</strong></td>
                <td>${'‚≠ê'.repeat(popularite)}</td>
            `;
            tableauBody.appendChild(row);
        });
        
    } catch (error) {
        console.error('Erreur chargement stats fili√®res:', error);
        UIHelpers.showError('Erreur lors du chargement des statistiques par fili√®re');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// =================== STATISTIQUES TEMPORELLES AVANC√âES ===================
async function chargerStatsTemporellesAvancees() {
    try {
        UIHelpers.showLoading(true);
        
        const response = await apiClient.getStatsTemporelles();
        const stats = response.stats || [];
        
        if (stats.length === 0) return;
        
        // Graphique d'√©volution principale
        const dataTemporel = {
            labels: stats.map(s => {
                const date = new Date(s.mois);
                return date.toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' });
            }),
            datasets: [{
                label: 'Candidatures',
                data: stats.map(s => parseInt(s.nombre_candidatures)),
                borderColor: COLORS.primary[0],
                backgroundColor: COLORS.primary[0] + '20',
                fill: true,
                tension: 0.4
            }, {
                label: 'Approuv√©es',
                data: stats.map(s => parseInt(s.approuves)),
                borderColor: COLORS.success[0],
                backgroundColor: COLORS.success[0] + '20',
                fill: true,
                tension: 0.4
            }]
        };
        
        createLineChart('chartTemporel', dataTemporel, {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        });
        
        // Tendances mensuelles (barres)
        const dataTendances = {
            labels: stats.map(s => {
                const date = new Date(s.mois);
                return date.toLocaleDateString('fr-FR', { month: 'long' });
            }),
            datasets: [{
                label: 'Hommes',
                data: stats.map(s => parseInt(s.hommes || 0)),
                backgroundColor: '#36A2EB'
            }, {
                label: 'Femmes',
                data: stats.map(s => parseInt(s.femmes || 0)),
                backgroundColor: '#FF6384'
            }]
        };
        
        createBarChart('chartTendances', dataTendances, {
            responsive: true,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true }
            }
        });
        
        // Analyse d'activit√©
        const totalCandidatures = stats.reduce((sum, s) => sum + parseInt(s.nombre_candidatures), 0);
        const moyenneMensuelle = (totalCandidatures / stats.length).toFixed(1);
        const picActivite = stats.reduce((max, s) => 
            parseInt(s.nombre_candidatures) > parseInt(max.nombre_candidatures) ? s : max
        );
        
        const analyseDiv = document.getElementById('analyseActivite');
        analyseDiv.innerHTML = `
            <div class="stat-detail">
                <h4>Pic d'Activit√©</h4>
                <p><strong>Mois le plus actif:</strong> ${new Date(picActivite.mois).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}</p>
                <p><strong>Candidatures:</strong> ${picActivite.nombre_candidatures}</p>
                <p><strong>Moyenne mensuelle:</strong> ${moyenneMensuelle}</p>
            </div>
        `;
        
    } catch (error) {
        console.error('Erreur chargement stats temporelles:', error);
        UIHelpers.showError('Erreur lors du chargement des statistiques temporelles');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// =================== ANALYSES AVANC√âES ===================
async function chargerAnalysesAvancees() {
    try {
        UIHelpers.showLoading(true);
        
        // Charger toutes les analyses avanc√©es en parall√®le
        const [
            responseGenreBac,
            responseMentions,
            responseLieux,
            responseGeneral
        ] = await Promise.all([
            apiClient.getStatsGenreBac(),
            apiClient.getStatsMentionsFilieres(),
            apiClient.getStatsByLieuObtention(),
            apiClient.getStatsDashboard()
        ]);
        
        // Graphique Genre √ó Type de Bac
        const statsGenreBac = responseGenreBac.stats || [];
        if (statsGenreBac.length > 0) {
            const genreLabels = [...new Set(statsGenreBac.map(s => s.genre))];
            const typeBacLabels = [...new Set(statsGenreBac.map(s => s.type_bac))];
            
            const datasets = genreLabels.map((genre, index) => ({
                label: genre === 'masculin' ? 'Hommes' : 'Femmes',
                data: typeBacLabels.map(typeBac => {
                    const stat = statsGenreBac.find(s => s.genre === genre && s.type_bac === typeBac);
                    return stat ? parseInt(stat.nombre) : 0;
                }),
                backgroundColor: index === 0 ? '#36A2EB' : '#FF6384',
                borderColor: '#fff',
                borderWidth: 1
            }));
            
            createBarChart('chartGenreBac', {
                labels: typeBacLabels,
                datasets: datasets
            }, {
                responsive: true,
                plugins: { legend: { position: 'top' } },
                scales: {
                    y: { beginAtZero: true }
                }
            });
        }
        
        // Graphique Mentions par Fili√®re
        const statsMentions = responseMentions.stats || [];
        if (statsMentions.length > 0) {
            const filieresMentions = statsMentions.slice(0, 8); // Top 8
            const mentionTypes = [...new Set(filieresMentions.map(s => s.mention))];
            
            const datasets = mentionTypes.map((mention, index) => ({
                label: mention,
                data: [...new Set(filieresMentions.map(s => s.filiere))].map(filiere => {
                    const stat = filieresMentions.find(s => s.filiere === filiere && s.mention === mention);
                    return stat ? parseInt(stat.nombre) : 0;
                }),
                backgroundColor: COLORS.primary[index % COLORS.primary.length],
                borderColor: '#fff',
                borderWidth: 1
            }));
            
            createBarChart('chartMentionsFilieres', {
                labels: [...new Set(filieresMentions.map(s => s.filiere))],
                datasets: datasets
            }, {
                responsive: true,
                plugins: { legend: { position: 'top' } },
                scales: {
                    x: { stacked: true },
                    y: { stacked: true, beginAtZero: true }
                }
            });
        }
        
        // Graphique R√©partition G√©ographique
        const statsLieux = responseLieux.stats || [];
        if (statsLieux.length > 0) {
            createPieChart('chartLieuObtention', {
                labels: statsLieux.map(s => s.lieu_obtention),
                datasets: [{
                    data: statsLieux.map(s => parseInt(s.nombre)),
                    backgroundColor: COLORS.success,
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            }, {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            });
        }
        
        // Indices de Performance
        const general = responseGeneral.general || {};
        const totalCandidatures = parseInt(general.total_candidatures || 0);
        const approuves = parseInt(general.approuves || 0);
        const tauxGlobal = totalCandidatures > 0 ? ((approuves / totalCandidatures) * 100).toFixed(1) : 0;
        
        document.getElementById('tauxGlobalApprobation').textContent = tauxGlobal + '%';
        
        // Fili√®re la plus demand√©e
        const topFilieres = responseGeneral.topFilieres || [];
        if (topFilieres.length > 0) {
            document.getElementById('filierePlusDemanndee').textContent = topFilieres[0].filiere;
        }
        
        // Diversit√© des profils
        const diversite = `${statsLieux.length} r√©gions, ${statsMentions.length > 0 ? [...new Set(statsMentions.map(s => s.mention))].length : 2} types de mentions`;
        document.getElementById('diversiteProfils').textContent = diversite;
        
        // Insights automatiques
        genererInsightsAutomatiques({
            general,
            statsLieux,
            statsMentions,
            topFilieres
        });
        
    } catch (error) {
        console.error('Erreur chargement analyses avanc√©es:', error);
        UIHelpers.showError('Erreur lors du chargement des analyses avanc√©es');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// =================== G√âN√âRATION D'INSIGHTS AUTOMATIQUES ===================
function genererInsightsAutomatiques(data) {
    const insights = [];
    const { general, statsLieux, topFilieres } = data;
    
    // Insight sur le taux d'approbation
    const tauxApprobation = (parseInt(general.approuves || 0) / parseInt(general.total_candidatures || 1)) * 100;
    if (tauxApprobation > 70) {
        insights.push(`üéâ Excellent taux d'approbation de ${tauxApprobation.toFixed(1)}% - Performance √©lev√©e du processus de s√©lection`);
    } else if (tauxApprobation < 30) {
        insights.push(`‚ö†Ô∏è Taux d'approbation faible (${tauxApprobation.toFixed(1)}%) - Opportunit√© d'am√©lioration du processus`);
    }
    
    // Insight sur la parit√©
    const hommes = parseInt(general.hommes || 0);
    const femmes = parseInt(general.femmes || 0);
    const total = hommes + femmes;
    if (total > 0) {
        const parite = Math.min(hommes, femmes) / Math.max(hommes, femmes);
        if (parite > 0.8) {
            insights.push(`‚öñÔ∏è Excellente parit√© homme-femme (${((Math.min(hommes, femmes) / total) * 100).toFixed(1)}%)`);
        } else {
            const dominant = hommes > femmes ? 'masculin' : 'f√©minin';
            insights.push(`üìä D√©s√©quilibre genre avec dominance ${dominant} (${((Math.max(hommes, femmes) / total) * 100).toFixed(1)}%)`);
        }
    }
    
    // Insight sur la diversit√© g√©ographique
    if (statsLieux && statsLieux.length > 0) {
        if (statsLieux.length >= 6) {
            insights.push(`üåç Excellente repr√©sentativit√© g√©ographique avec ${statsLieux.length} r√©gions`);
        }
        
        const regionDominante = statsLieux[0];
        if (regionDominante && parseInt(regionDominante.nombre) > (parseInt(general.total_candidatures || 0) * 0.5)) {
            insights.push(`üìç Forte concentration r√©gionale : ${regionDominante.lieu_obtention} (${((parseInt(regionDominante.nombre) / parseInt(general.total_candidatures || 1)) * 100).toFixed(1)}%)`);
        }
    }
    
    // Insight sur la concentration des fili√®res
    if (topFilieres && topFilieres.length > 0) {
        const top3 = topFilieres.slice(0, 3).reduce((sum, f) => sum + parseInt(f.nombre), 0);
        const concentrationTop3 = (top3 / parseInt(general.total_candidatures || 1)) * 100;
        if (concentrationTop3 > 60) {
            insights.push(`üî• Forte concentration sur 3 fili√®res (${concentrationTop3.toFixed(1)}% des candidatures)`);
        }
    }
    
    // Afficher les insights
    const insightsDiv = document.getElementById('insightsAutomatiques');
    if (insights.length > 0) {
        insightsDiv.innerHTML = insights.map(insight => 
            `<div class="stat-detail" style="margin: 10px 0; padding: 15px; background: #f8f9fa; border-left: 4px solid #667eea;">
                ${insight}
            </div>`
        ).join('');
    } else {
        insightsDiv.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 10px;">ü§î</div>
                <p>Aucun insight particulier d√©tect√© avec les donn√©es actuelles.</p>
            </div>
        `;
    }
}
function genererBadgeStatut(statut) {
    switch(statut) {
        case 'approuve':
            return '<span class="status-badge-large status-approved-large">‚úÖ Dossier Approuv√©</span>';
        case 'rejete':
            return '<span class="status-badge-large status-rejected-large">‚ùå Dossier Rejet√©</span>';
        default:
            return '<span class="status-badge-large status-pending-large">‚è≥ En Attente de Validation</span>';
    }
}

// Fonction pour t√©l√©charger un document sp√©cifique
async function telechargerDocument(applicationId, documentType) {
    try {
        UIHelpers.showLoading(true);
        await apiClient.downloadDocument(applicationId, documentType);
        UIHelpers.showSuccess('Document t√©l√©charg√© avec succ√®s');
    } catch (error) {
        console.error('Erreur t√©l√©chargement document:', error);
        UIHelpers.showError('Erreur lors du t√©l√©chargement du document');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Fonction pour t√©l√©charger le quitus depuis les d√©tails
async function telechargerQuitusDepuisDetails(applicationId) {
    try {
        UIHelpers.showLoading(true);
        
        // R√©cup√©rer les donn√©es du dossier
        const response = await apiClient.getApplication(applicationId);
        const application = response.application;
        
        // G√©n√©rer le quitus avec les donn√©es
        await genererQuitusAvecDonnees(application);
        
    } catch (error) {
        console.error('Erreur t√©l√©chargement quitus:', error);
        UIHelpers.showError('Erreur lors du t√©l√©chargement du quitus');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Fonction pour fermer le modal
function fermerModalDetails() {
    const overlay = document.getElementById('detailsModalOverlay');
    if (overlay) {
        overlay.remove();
    }
}
// Variables globales
let currentFacultes = [];
let currentFilieres = [];
let currentTypeBacs = [];
let currentDiplomes = [];

// Navigation entre les onglets
function openFormationTab(tabName) {
    // Masquer tous les contenus d'onglets
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Afficher l'onglet s√©lectionn√©
    document.getElementById(`${tabName}-tab`).classList.add('active');
    event.target.classList.add('active');
    
    // Charger les donn√©es de l'onglet
    if (tabName === 'facultes') {
        chargerFacultes();
    } else if (tabName === 'filieres') {
        chargerFilieres();
    }else if (tabName === 'diplomes') {
        chargerDiplomes();
    } else if (tabName === 'typeBacs') {
        chargerTypeBacs();
    }
}

// Chargement des facult√©s
async function chargerFacultes() {
    try {
        UIHelpers.showLoading(true);
        const response = await apiClient.getFacultes();
        currentFacultes = response.facultes || [];
        
        const tableau = document.getElementById('tableauFacultes');
        tableau.innerHTML = '';
        
        if (currentFacultes.length === 0) {
            tableau.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #666;">Aucune facult√© trouv√©e</td></tr>';
            return;
        }
        
        currentFacultes.forEach(faculte => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${faculte.nom}</strong></td>
                <td>${faculte.libelle}</td>
                <td>${faculte.description || '-'}</td>
                <td><span class="stat-badge">${faculte.nombre_filieres || 0} fili√®res</span></td>
                <td><span class="status-badge ${faculte.active ? 'status-approved' : 'status-rejected'}">${faculte.active ? 'Active' : 'Inactive'}</span></td>
                <td>
                    <button class="btn btn-secondary" style="padding: 5px 10px; margin: 2px;" onclick="modifierFaculte(${faculte.id})">Modifier</button>
                    <button class="btn" style="padding: 5px 10px; margin: 2px; background: #dc3545; color: white;" onclick="supprimerFaculte(${faculte.id})">Supprimer</button>
                </td>
            `;
            tableau.appendChild(row);
        });
        
    } catch (error) {
        console.error('Erreur chargement facult√©s:', error);
        UIHelpers.showError('Erreur lors du chargement des facult√©s');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Chargement des fili√®res
async function chargerFilieres() {
    try {
        UIHelpers.showLoading(true);
        const response = await apiClient.getFilieres();
        currentFilieres = response.filieres || [];
        
        const tableau = document.getElementById('tableauFilieres');
        tableau.innerHTML = '';
        
        if (currentFilieres.length === 0) {
            tableau.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #666;">Aucune fili√®re trouv√©e</td></tr>';
            return;
        }
        
        currentFilieres.forEach(filiere => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${filiere.nom}</strong></td>
                <td>${filiere.libelle}</td>
                <td>${filiere.faculte_libelle}</td>
                <td>${filiere.capacite_max || 'Illimit√©e'}</td>
                <td>${filiere.types_bac_autorises ? filiere.types_bac_autorises.join(', ') : 'Aucun'}</td>
                <td><span class="stat-badge">${filiere.nombre_candidatures || 0} candidatures</span></td>
                <td><span class="status-badge ${filiere.active ? 'status-approved' : 'status-rejected'}">${filiere.active ? 'Active' : 'Inactive'}</span></td>
                <td>
                    <button class="btn btn-secondary" style="padding: 5px 10px; margin: 2px;" onclick="modifierFiliere(${filiere.id})">Modifier</button>
                    <button class="btn" style="padding: 5px 10px; margin: 2px; background: #dc3545; color: white;" onclick="desactiverFiliere(${filiere.id})">D√©sactiver</button>
                </td>
            `;
            tableau.appendChild(row);
        });
        
    } catch (error) {
        console.error('Erreur chargement fili√®res:', error);
        UIHelpers.showError('Erreur lors du chargement des fili√®res');
    } finally {
        UIHelpers.showLoading(false);
    }
}

async function chargerDiplomes() {
    try {
        console.log('üìö Chargement dipl√¥mes...');
        UIHelpers.showLoading(true);
        
        const response = await apiClient.getDiplomes();
        currentDiplomes = response.diplomes || [];
        
        console.log(`‚úÖ ${currentDiplomes.length} dipl√¥mes charg√©s`);
        
        const tableau = document.getElementById('tableauDiplomes');
        if (!tableau) {
            console.error('‚ùå √âl√©ment tableauDiplomes non trouv√©');
            return;
        }
        
        tableau.innerHTML = '';
        
        if (currentDiplomes.length === 0) {
            tableau.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #666;">Aucun dipl√¥me trouv√©</td></tr>';
            return;
        }
        
        currentDiplomes.forEach(diplome => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${diplome.filiere_libelle || diplome.filiere_nom || '-'}</td>
                <td>${diplome.libelle}</td>
                <td>${diplome.faculte_libelle || diplome.faculte_nom}</td>
                <td><span class="status-badge ${diplome.active ? 'status-approved' : 'status-rejected'}">${diplome.active ? 'Actif' : 'Inactif'}</span></td>
                <td>
                    <button class="btn btn-secondary" style="padding: 5px 10px; margin: 2px;" onclick="modifierDiplome(${diplome.id})">Modifier</button>
                    <button class="btn" style="padding: 5px 10px; margin: 2px; background: #dc3545; color: white;" onclick="supprimerDiplome(${diplome.id})">Supprimer</button>
                </td>
            `;
            tableau.appendChild(row);
        });
        
    } catch (error) {
        console.error('‚ùå Erreur chargement dipl√¥mes:', error);
        UIHelpers.showError('Erreur lors du chargement des dipl√¥mes: ' + error.message);
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Chargement des types de bac
async function chargerTypeBacs() {
    try {
        UIHelpers.showLoading(true);
        const response = await apiClient.getTypeBacs();
        currentTypeBacs = response.typeBacs || [];
        
        const tableau = document.getElementById('tableauTypeBacs');
        tableau.innerHTML = '';
        
        if (currentTypeBacs.length === 0) {
            tableau.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #666;">Aucun type de bac trouv√©</td></tr>';
            return;
        }
        
        currentTypeBacs.forEach(typeBac => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${typeBac.nom}</strong></td>
                <td>${typeBac.libelle}</td>
                <td>${typeBac.description || '-'}</td>
                <td><span class="stat-badge">${typeBac.nombre_filieres || 0} fili√®res</span></td>
                <td><span class="status-badge ${typeBac.active ? 'status-approved' : 'status-rejected'}">${typeBac.active ? 'Active' : 'Inactive'}</span></td>
                <td>
                    <button class="btn btn-secondary" style="padding: 5px 10px; margin: 2px;" onclick="modifierTypeBac(${typeBac.id})">Modifier</button>
                    <button class="btn" style="padding: 5px 10px; margin: 2px; background: #dc3545; color: white;" onclick="supprimerTypeBac(${typeBac.id})">Supprimer</button>
                </td>
            `;
            tableau.appendChild(row);
        });
        
    } catch (error) {
        console.error('Erreur chargement types de bac:', error);
        UIHelpers.showError('Erreur lors du chargement des types de bac');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Gestion des facult√©s
function ouvrirModalFaculte(faculte = null) {
    const modal = document.getElementById('ajoutFaculteModal');
    const titre = document.getElementById('titreFaculteModal');
    const form = document.getElementById('faculteForm');
    
    if (faculte) {
        titre.textContent = 'Modifier la facult√©';
        document.getElementById('faculteId').value = faculte.id;
        document.getElementById('faculteNom').value = faculte.nom;
        document.getElementById('faculteLibelle').value = faculte.libelle;
        document.getElementById('faculteDescription').value = faculte.description || '';
        document.getElementById('faculteActive').checked = faculte.active !== false;
    } else {
        titre.textContent = 'Ajouter une facult√©';
        form.reset();
        document.getElementById('faculteId').value = '';
    }
    
    openModal('ajoutFaculteModal');
}

async function sauvegarderFaculte(event) {
    event.preventDefault();
    
    try {
        UIHelpers.showLoading(true);
        
        const faculteData = {
            nom: document.getElementById('faculteNom').value,
            libelle: document.getElementById('faculteLibelle').value,
            description: document.getElementById('faculteDescription').value,
            active: document.getElementById('faculteActive').checked
        };
        
        const id = document.getElementById('faculteId').value;
        if (id) {
            faculteData.id = id;
        }
        
        await apiClient.saveFaculte(faculteData);
        
        closeModal('ajoutFaculteModal');
        chargerFacultes();
        UIHelpers.showSuccess(`Facult√© ${id ? 'modifi√©e' : 'ajout√©e'} avec succ√®s`);
        
    } catch (error) {
        console.error('Erreur sauvegarde facult√©:', error);
        UIHelpers.showError(error.message || 'Erreur lors de la sauvegarde');
    } finally {
        UIHelpers.showLoading(false);
    }
}

async function supprimerFaculte(id) {
    if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette facult√© ? Cette action est irr√©versible.')) {
        return;
    }
    
    try {
        UIHelpers.showLoading(true);
        await apiClient.deleteFaculte(id);
        chargerFacultes();
        UIHelpers.showSuccess('Facult√© supprim√©e avec succ√®s');
    } catch (error) {
        console.error('Erreur suppression facult√©:', error);
        UIHelpers.showError(error.message || 'Erreur lors de la suppression');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Gestion des fili√®res
// Remplacer les fonctions d'ouverture de modal existantes par celles-ci dans votre index.html

// Fonction pour ouvrir le modal d'ajout/modification de fili√®re - CORRIG√âE
// Fonction corrig√©e pour ouvrir le modal d'ajout/modification de fili√®re
// Fonction CORRIG√âE pour ouvrir le modal fili√®re
async function ouvrirModalFiliere(filiere = null) {
    console.log('üîß ouvrirModalFiliere appel√©e', filiere);
    
    try {
        // 1. D'abord ouvrir le modal IMM√âDIATEMENT
        openModal('ajoutFiliereModal');
        console.log('‚úÖ Modal ouvert');
        
        // 2. Afficher un message de chargement
        const container = document.getElementById('typesBacContainer');
        const selectFacultes = document.getElementById('filiereFaculte');
        
        if (container) container.innerHTML = '<p>Chargement des types de bac...</p>';
        if (selectFacultes) selectFacultes.innerHTML = '<option value="">Chargement des facult√©s...</option>';
        
        // 3. Configurer le titre du modal
        const titre = document.getElementById('titreFiliereModal');
        if (filiere) {
            titre.textContent = 'Modifier la fili√®re';
            document.getElementById('filiereId').value = filiere.id || '';
        } else {
            titre.textContent = 'Ajouter une fili√®re';
            document.getElementById('filiereId').value = '';
        }
        
        // 4. Charger les donn√©es ASYNCHRONEMENT
        await chargerDonneesFiliereForm();
        
        // 5. Si c'est une modification, pr√©-remplir les champs
        if (filiere) {
            console.log('üìù Pr√©-remplissage pour modification', filiere);
            
            document.getElementById('filiereNom').value = filiere.nom || '';
            document.getElementById('filiereLibelle').value = filiere.libelle || '';
            document.getElementById('filiereFaculte').value = filiere.faculte_id || '';
            document.getElementById('filiereCapacite').value = filiere.capacite_max || '';
            document.getElementById('filiereDescription').value = filiere.description || '';
            document.getElementById('filiereActive').checked = filiere.active !== false;
            
            // Cocher les types de bac autoris√©s
            if (filiere.types_bac_autorises) {
                setTimeout(() => {
                    const checkboxes = document.querySelectorAll('#typesBacContainer input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        const typeBacId = checkbox.value;
                        // V√©rifier si ce type de bac est dans la liste des autoris√©s
                        if (Array.isArray(filiere.types_bac_autorises)) {
                            checkbox.checked = filiere.types_bac_autorises.includes(parseInt(typeBacId)) || 
                                            filiere.types_bac_autorises.includes(typeBacId);
                        }
                    });
                }, 500);
            }
        } else {
            // Pour l'ajout, r√©initialiser le formulaire
            document.getElementById('filiereForm').reset();
            document.getElementById('filiereActive').checked = true;
        }
        
        console.log('‚úÖ Modal fili√®re pr√™t');
        
    } catch (error) {
        console.error('‚ùå Erreur ouverture modal fili√®re:', error);
        UIHelpers.showError('Erreur: ' + error.message);
    }
}
// Fonction similaire pour les facult√©s
async function ouvrirModalFaculte(faculte = null) {
    try {
        const titre = document.getElementById('titreFaculteModal');
        const form = document.getElementById('faculteForm');
        
        if (faculte) {
            titre.textContent = 'Modifier la facult√©';
            document.getElementById('faculteId').value = faculte.id;
            document.getElementById('faculteNom').value = faculte.nom;
            document.getElementById('faculteLibelle').value = faculte.libelle;
            document.getElementById('faculteDescription').value = faculte.description || '';
            document.getElementById('faculteActive').checked = faculte.active !== false;
        } else {
            titre.textContent = 'Ajouter une facult√©';
            form.reset();
            document.getElementById('faculteId').value = '';
        }
        
        openModal('ajoutFaculteModal');
        
    } catch (error) {
        console.error('‚ùå Erreur ouverture modal facult√©:', error);
        UIHelpers.showError('Erreur lors du chargement du formulaire');
    }
}

async function chargerFilieresParFaculte() {
    try {
        const selectFaculte = document.getElementById('diplomeFaculte');
        const selectFiliere = document.getElementById('diplomeFiliere');
        const faculteId = selectFaculte.value;
        
        if (!faculteId) {
            selectFiliere.innerHTML = '<option value="">S√©lectionner d\'abord une facult√©</option>';
            selectFiliere.disabled = true;
            return;
        }
        
        console.log('üìö Chargement des fili√®res pour facult√©:', faculteId);
        
        selectFiliere.innerHTML = '<option value="">Chargement des fili√®res...</option>';
        selectFiliere.disabled = true;
        
        // R√©cup√©rer toutes les fili√®res
        const response = await apiClient.getFilieres();
        const filieres = response.filieres || [];
        
        // Filtrer par facult√©
        const filieresFiltered = filieres.filter(f => f.faculte_id == faculteId);
        
        console.log(`‚úÖ ${filieresFiltered.length} fili√®res trouv√©es`);
        
        selectFiliere.innerHTML = '<option value="">S√©lectionner une fili√®re</option>';
        
        if (filieresFiltered.length > 0) {
            filieresFiltered.forEach(filiere => {
                const option = document.createElement('option');
                option.value = filiere.id;
                option.textContent = `${filiere.nom} - ${filiere.libelle}`;
                selectFiliere.appendChild(option);
            });
            selectFiliere.disabled = false;
        } else {
            selectFiliere.innerHTML = '<option value="">Aucune fili√®re disponible pour cette facult√©</option>';
        }
        
    } catch (error) {
        console.error('‚ùå Erreur chargement fili√®res:', error);
        const selectFiliere = document.getElementById('diplomeFiliere');
        selectFiliere.innerHTML = '<option value="">Erreur de chargement</option>';
        UIHelpers.showError('Erreur lors du chargement des fili√®res');
    }
}


// Fonction pour les types de bac
async function ouvrirModalTypeBac(typeBac = null) {
    try {
        const titre = document.getElementById('titreTypeBacModal');
        const form = document.getElementById('typeBacForm');
        
        if (typeBac) {
            titre.textContent = 'Modifier le type de bac';
            document.getElementById('typeBacId').value = typeBac.id;
            document.getElementById('typeBacNom').value = typeBac.nom;
            document.getElementById('typeBacLibelle').value = typeBac.libelle;
            document.getElementById('typeBacDescription').value = typeBac.description || '';
            document.getElementById('typeBacActive').checked = typeBac.active !== false;
        } else {
            titre.textContent = 'Ajouter un type de bac';
            form.reset();
            document.getElementById('typeBacId').value = '';
        }
        
        openModal('ajoutTypeBacModal');
        
    } catch (error) {
        console.error('‚ùå Erreur ouverture modal type de bac:', error);
        UIHelpers.showError('Erreur lors du chargement du formulaire');
    }
}

// Corrections des fonctions de modification pour utiliser les bonnes fonctions d'ouverture
function modifierFaculte(id) {
    console.log('üîß Modification facult√© ID:', id);
    const faculte = currentFacultes?.find(f => f.id === id);
    if (faculte) {
        ouvrirModalFaculte(faculte);
    } else {
        console.error('‚ùå Facult√© introuvable:', id);
        UIHelpers.showError('Facult√© introuvable');
    }
}

function modifierFiliere(id) {
    console.log('üîß Modification fili√®re ID:', id);
    const filiere = currentFilieres?.find(f => f.id === id);
    if (filiere) {
        ouvrirModalFiliere(filiere);
    } else {
        console.error('‚ùå Fili√®re introuvable:', id);
        UIHelpers.showError('Fili√®re introuvable');
    }
}

function modifierTypeBac(id) {
    console.log('üîß Modification type de bac ID:', id);
    const typeBac = currentTypeBacs?.find(t => t.id === id);
    if (typeBac) {
        ouvrirModalTypeBac(typeBac);
    } else {
        console.error('‚ùå Type de bac introuvable:', id);
        UIHelpers.showError('Type de bac introuvable');
    }
}



async function sauvegarderFiliere(event) {
    event.preventDefault();
    
    try {
        UIHelpers.showLoading(true);
        
        // R√©cup√©rer les types de bac s√©lectionn√©s
        const typesBacIds = [];
        document.querySelectorAll('#typesBacContainer input[type="checkbox"]:checked').forEach(checkbox => {
            typesBacIds.push(checkbox.value);
        });
        
        const filiereData = {
            nom: document.getElementById('filiereNom').value,
            libelle: document.getElementById('filiereLibelle').value,
            faculte_id: document.getElementById('filiereFaculte').value,
            capacite_max: document.getElementById('filiereCapacite').value || null,
            description: document.getElementById('filiereDescription').value,
            active: document.getElementById('filiereActive').checked,
            types_bac_ids: typesBacIds
        };
        
        const id = document.getElementById('filiereId').value;
        if (id) {
            filiereData.id = id;
        }
        
        await apiClient.saveFiliere(filiereData);
        
        closeModal('ajoutFiliereModal');
        chargerFilieres();
        UIHelpers.showSuccess(`Fili√®re ${id ? 'modifi√©e' : 'ajout√©e'} avec succ√®s`);
        
    } catch (error) {
        console.error('Erreur sauvegarde fili√®re:', error);
        UIHelpers.showError(error.message || 'Erreur lors de la sauvegarde');
    } finally {
        UIHelpers.showLoading(false);
    }
}

async function sauvegarderDiplome(event) {
    event.preventDefault();
    
    try {
        console.log('üíæ Sauvegarde dipl√¥me...');
        UIHelpers.showLoading(true);
        
        const diplomeData = {
            libelle: document.getElementById('diplomeLibelle').value.trim(),
            faculte_id: parseInt(document.getElementById('diplomeFaculte').value),
            filiere_id: parseInt(document.getElementById('diplomeFiliere').value)
        };
        
        const id = document.getElementById('diplomeId').value;
        if (id) {
            diplomeData.id = parseInt(id);
            diplomeData.active = true;
        }
        
        console.log('üì§ Donn√©es √† envoyer:', diplomeData);
        
        // Validation
        if (!diplomeData.libelle || !diplomeData.faculte_id || !diplomeData.filiere_id) {
            throw new Error('Tous les champs sont obligatoires');
        }
        
        if (isNaN(diplomeData.faculte_id) || isNaN(diplomeData.filiere_id)) {
            throw new Error('Veuillez s√©lectionner une facult√© et une fili√®re valides');
        }
        
        await apiClient.saveDiplome(diplomeData);
        
        console.log('‚úÖ Dipl√¥me sauvegard√©');
        
        closeModal('ajoutDiplomeModal');
        await chargerDiplomes();
        
        UIHelpers.showSuccess(`Dipl√¥me ${id ? 'modifi√©' : 'ajout√©'} avec succ√®s`);
        
    } catch (error) {
        console.error('‚ùå Erreur sauvegarde dipl√¥me:', error);
        UIHelpers.showError(error.message || 'Erreur lors de la sauvegarde');
    } finally {
        UIHelpers.showLoading(false);
    }
}

function modifierDiplome(id) {
    console.log('üîß Modification dipl√¥me ID:', id);
    const diplome = currentDiplomes?.find(d => d.id === id);
    if (diplome) {
        ouvrirModalDiplome(diplome);
    } else {
        console.error('‚ùå Dipl√¥me introuvable:', id);
        UIHelpers.showError('Dipl√¥me introuvable');
    }
}

async function supprimerDiplome(id) {
    if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce dipl√¥me ?')) {
        return;
    }
    
    try {
        UIHelpers.showLoading(true);
        await apiClient.deleteDiplome(id);
        await chargerDiplomes();
        UIHelpers.showSuccess('Dipl√¥me supprim√© avec succ√®s');
    } catch (error) {
        console.error('‚ùå Erreur suppression dipl√¥me:', error);
        UIHelpers.showError(error.message || 'Erreur lors de la suppression');
    } finally {
        UIHelpers.showLoading(false);
    }
}
// Gestion des types de bac
function ouvrirModalTypeBac(typeBac = null) {
    const modal = document.getElementById('ajoutTypeBacModal');
    const titre = document.getElementById('titreTypeBacModal');
    const form = document.getElementById('typeBacForm');
    
    if (typeBac) {
        titre.textContent = 'Modifier le type de bac';
        document.getElementById('typeBacId').value = typeBac.id;
        document.getElementById('typeBacNom').value = typeBac.nom;
        document.getElementById('typeBacLibelle').value = typeBac.libelle;
        document.getElementById('typeBacDescription').value = typeBac.description || '';
        document.getElementById('typeBacActive').checked = typeBac.active !== false;
    } else {
        titre.textContent = 'Ajouter un type de bac';
        form.reset();
        document.getElementById('typeBacId').value = '';
    }
    
    openModal('ajoutTypeBacModal');
}

async function sauvegarderTypeBac(event) {
    event.preventDefault();
    
    try {
        UIHelpers.showLoading(true);
        
        const typeBacData = {
            nom: document.getElementById('typeBacNom').value,
            libelle: document.getElementById('typeBacLibelle').value,
            description: document.getElementById('typeBacDescription').value,
            active: document.getElementById('typeBacActive').checked
        };
        
        const id = document.getElementById('typeBacId').value;
        if (id) {
            typeBacData.id = id;
        }
        
        await apiClient.saveTypeBac(typeBacData);
        
        closeModal('ajoutTypeBacModal');
        chargerTypeBacs();
        UIHelpers.showSuccess(`Type de bac ${id ? 'modifi√©' : 'ajout√©'} avec succ√®s`);
        
    } catch (error) {
        console.error('Erreur sauvegarde type de bac:', error);
        UIHelpers.showError(error.message || 'Erreur lors de la sauvegarde');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Fonctions de modification
function modifierFaculte(id) {
    const faculte = currentFacultes.find(f => f.id === id);
    if (faculte) {
        ouvrirModalFaculte(faculte);
    }
}

function modifierFiliere(id) {
    const filiere = currentFilieres.find(f => f.id === id);
    if (filiere) {
        ouvrirModalFiliere(filiere);
    }
}

function modifierTypeBac(id) {
    const typeBac = currentTypeBacs.find(t => t.id === id);
    if (typeBac) {
        ouvrirModalTypeBac(typeBac);
    }
}

// Mise √† jour de la navigation admin
function showAdminSection(section) {
    if (section === 'gestionFormations') {
        showPage('gestionFormations');
        // Ouvrir l'onglet facult√©s par d√©faut
        setTimeout(() => openFormationTab('facultes'), 100);
    } else {
        showPage(section);
    }
}

// Mettre √† jour le tableau de bord admin pour inclure le nouveau lie
// Fonction pour ouvrir le modal d'ajout/modification de fili√®re
async function ouvrirModalFiliere(filiere = null) {
    try {
        // Charger les donn√©es n√©cessaires pour le formulaire
        await chargerDonneesFiliereForm();
        
        const modal = document.getElementById('ajoutFiliereModal');
        const titre = document.getElementById('titreFiliereModal');
        
        if (filiere) {
            titre.textContent = 'Modifier la fili√®re';
            document.getElementById('filiereId').value = filiere.id;
            document.getElementById('filiereNom').value = filiere.nom || '';
            document.getElementById('filiereLibelle').value = filiere.libelle || '';
            document.getElementById('filiereFaculte').value = filiere.faculte_id || '';
            document.getElementById('filiereCapacite').value = filiere.capacite_max || '';
            document.getElementById('filiereDescription').value = filiere.description || '';
            document.getElementById('filiereActive').checked = filiere.active !== false;
            
            // Cocher les types de bac autoris√©s
            if (filiere.types_bac_autorises) {
                document.querySelectorAll('#typesBacContainer input[type="checkbox"]').forEach(checkbox => {
                    const typeBacNom = checkbox.value;
                    checkbox.checked = filiere.types_bac_autorises.includes(typeBacNom);
                });
            }
        } else {
            titre.textContent = 'Ajouter une fili√®re';
            document.getElementById('filiereForm').reset();
            document.getElementById('filiereId').value = '';
        }
        
        openModal('ajoutFiliereModal');
    } catch (error) {
        console.error('Erreur ouverture modal fili√®re:', error);
        UIHelpers.showError('Erreur lors du chargement du formulaire');
    }
}

async function ouvrirModalDiplome(diplome = null) {
    try {
        console.log('üéì Ouverture modal dipl√¥me...', diplome);
        
        // Charger les facult√©s
        const responseFacultes = await apiClient.getFacultes();
        const facultes = responseFacultes.facultes || [];
        
        const selectFacultes = document.getElementById('diplomeFaculte');
        const selectFilieres = document.getElementById('diplomeFiliere');
        
        if (!selectFacultes || !selectFilieres) {
            console.error('‚ùå √âl√©ments du formulaire non trouv√©s');
            return;
        }
        
        // R√©initialiser les selects
        selectFacultes.innerHTML = '<option value="">S√©lectionner une facult√©</option>';
        selectFilieres.innerHTML = '<option value="">S√©lectionner d\'abord une facult√©</option>';
        
        facultes.forEach(faculte => {
            const option = document.createElement('option');
            option.value = faculte.id;
            option.textContent = `${faculte.nom} - ${faculte.libelle}`;
            selectFacultes.appendChild(option);
        });
        
        const titre = document.getElementById('titreDiplomeModal');
        const form = document.getElementById('diplomeForm');
        
        if (diplome) {
            titre.textContent = 'Modifier le dipl√¥me';
            document.getElementById('diplomeId').value = diplome.id;
            document.getElementById('diplomeLibelle').value = diplome.libelle;
            document.getElementById('diplomeFaculte').value = diplome.faculte_id;
            
            // Charger les fili√®res de cette facult√©
            if (diplome.faculte_id) {
                await chargerFilieresParFaculte();
                // S√©lectionner la fili√®re apr√®s chargement
                setTimeout(() => {
                    document.getElementById('diplomeFiliere').value = diplome.filiere_id || '';
                }, 300);
            }
        } else {
            titre.textContent = 'Ajouter un dipl√¥me';
            form.reset();
            document.getElementById('diplomeId').value = '';
        }
        
        openModal('ajoutDiplomeModal');
        console.log('‚úÖ Modal dipl√¥me ouvert');
        
    } catch (error) {
        console.error('‚ùå Erreur ouverture modal dipl√¥me:', error);
        UIHelpers.showError('Erreur lors du chargement du formulaire: ' + error.message);
    }
}


// Fonction pour charger les donn√©es du formulaire fili√®re
// Remplacer la fonction chargerDonneesFiliereForm existante par celle-ci dans votre index.html

// Fonction pour charger les donn√©es du formulaire fili√®re
async function chargerDonneesFiliereForm() {
    try {
        UIHelpers.showLoading(true);
        
        console.log('üìÑ Chargement des facult√©s...');
        
        // Charger les facult√©s - Utiliser la route admin
        const responseFacultes = await apiClient.getFacultes(); // Route admin
        console.log('‚úÖ Facult√©s charg√©es:', responseFacultes);
        
        const selectFacultes = document.getElementById('filiereFaculte');
        if (!selectFacultes) {
            console.error('‚ùå √âl√©ment filiereFaculte introuvable');
            return;
        }
        
        selectFacultes.innerHTML = '<option value="">S√©lectionner une facult√©</option>';
        
        if (responseFacultes && responseFacultes.facultes && responseFacultes.facultes.length > 0) {
            responseFacultes.facultes.forEach(faculte => {
                const option = document.createElement('option');
                option.value = faculte.id;
                option.textContent = `${faculte.nom} - ${faculte.libelle}`;
                selectFacultes.appendChild(option);
            });
            console.log(`‚úÖ ${responseFacultes.facultes.length} facult√©s ajout√©es au select`);
        } else {
            console.warn('‚ö†Ô∏è Aucune facult√© trouv√©e');
            selectFacultes.innerHTML = '<option value="">Aucune facult√© disponible</option>';
        }
        
        console.log('üìÑ Chargement des types de bac...');
        
        // Charger les types de bac - Utiliser la route admin
        const responseTypeBacs = await apiClient.getTypeBacs(); // Route admin
        console.log('‚úÖ Types de bac charg√©s:', responseTypeBacs);
        
        const container = document.getElementById('typesBacContainer');
        if (!container) {
            console.error('‚ùå √âl√©ment typesBacContainer introuvable');
            return;
        }
        
        container.innerHTML = '';
        
        if (responseTypeBacs && responseTypeBacs.typeBacs && responseTypeBacs.typeBacs.length > 0) {
            responseTypeBacs.typeBacs.forEach(typeBac => {
                const div = document.createElement('div');
                div.className = 'type-bac-checkbox';
                div.innerHTML = `
                    <input type="checkbox" id="typeBac_${typeBac.id}" value="${typeBac.id}" name="typeBac">
                    <label for="typeBac_${typeBac.id}">${typeBac.libelle} (${typeBac.nom})</label>
                `;
                container.appendChild(div);
            });
            console.log(`‚úÖ ${responseTypeBacs.typeBacs.length} types de bac ajout√©s`);
        } else {
            console.warn('‚ö†Ô∏è Aucun type de bac trouv√©');
            container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Aucun type de bac disponible</p>';
        }
        
    } catch (error) {
        console.error('‚ùå Erreur chargement donn√©es fili√®re:', error);
        UIHelpers.showError('Erreur lors du chargement des donn√©es: ' + error.message);
        
        // Remplir les selects avec des messages d'erreur
        const selectFacultes = document.getElementById('filiereFaculte');
        if (selectFacultes) {
            selectFacultes.innerHTML = '<option value="">Erreur de chargement des facult√©s</option>';
        }
        
        const container = document.getElementById('typesBacContainer');
        if (container) {
            container.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 20px;">Erreur lors du chargement des types de bac</p>';
        }
    } finally {
        UIHelpers.showLoading(false);
    }
}

async function chargerDonneesDiplomeForm() {
    try {
        UIHelpers.showLoading(true);
        
        console.log('üìÑ Chargement des facult√©s...');
        
        // Charger les facult√©s - Utiliser la route admin
        const responseFacultes = await apiClient.getFacultes(); // Route admin
        console.log('‚úÖ Facult√©s charg√©es:', responseFacultes);
        
        const selectFacultes = document.getElementById('diplomeFaculte');
        if (!selectFacultes) {
            console.error('‚ùå √âl√©ment diplomeFaculte introuvable');
            return;
        }
        
        selectFacultes.innerHTML = '<option value="">S√©lectionner une facult√©</option>';
        
        if (responseFacultes && responseFacultes.facultes && responseFacultes.facultes.length > 0) {
            responseFacultes.facultes.forEach(faculte => {
                const option = document.createElement('option');
                option.value = faculte.id;
                option.textContent = `${faculte.nom} - ${faculte.libelle}`;
                selectFacultes.appendChild(option);
            });
            console.log(`‚úÖ ${responseFacultes.facultes.length} facult√©s ajout√©es au select`);
        } else {
            console.warn('‚ö†Ô∏è Aucune facult√© trouv√©e');
            selectFacultes.innerHTML = '<option value="">Aucune facult√© disponible</option>';
        }
    
        
    } catch (error) {
        console.error('‚ùå Erreur chargement donn√©es diplome:', error);
        UIHelpers.showError('Erreur lors du chargement des donn√©es: ' + error.message);
        
        // Remplir les selects avec des messages d'erreur
        const selectFacultes = document.getElementById('filiereFaculte');
        if (selectFacultes) {
            selectFacultes.innerHTML = '<option value="">Erreur de chargement des facult√©s</option>';
        }
        
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Fonction pour sauvegarder une fili√®re
// Fonction pour sauvegarder une fili√®re - CORRIG√âE
async function sauvegarderFiliere(event) {
    event.preventDefault();
    
    try {
        UIHelpers.showLoading(true);
        
        console.log('üíæ D√©but sauvegarde fili√®re');
        
        // R√©cup√©rer les types de bac s√©lectionn√©s
        const typesBacIds = [];
        const selectedCheckboxes = document.querySelectorAll('#typesBacContainer input[type="checkbox"]:checked');
        
        console.log(`üìã ${selectedCheckboxes.length} types de bac s√©lectionn√©s`);
        
        selectedCheckboxes.forEach(checkbox => {
            const typeBacId = parseInt(checkbox.value);
            if (!isNaN(typeBacId)) {
                typesBacIds.push(typeBacId);
            }
        });
        
        console.log('üè∑Ô∏è IDs des types de bac:', typesBacIds);
        
        // Validation des champs obligatoires
        const nom = document.getElementById('filiereNom').value?.trim();
        const libelle = document.getElementById('filiereLibelle').value?.trim();
        const faculteId = document.getElementById('filiereFaculte').value;
        
        if (!nom || !libelle || !faculteId) {
            throw new Error('Le nom, le libell√© et la facult√© sont obligatoires');
        }
        
        if (typesBacIds.length === 0) {
            throw new Error('Veuillez s√©lectionner au moins un type de bac autoris√©');
        }
        
        const filiereData = {
            nom: nom.toUpperCase(),
            libelle: libelle,
            faculte_id: parseInt(faculteId),
            capacite_max: document.getElementById('filiereCapacite').value || null,
            description: document.getElementById('filiereDescription').value?.trim() || null,
            active: document.getElementById('filiereActive').checked,
            types_bac_ids: typesBacIds
        };
        
        const id = document.getElementById('filiereId').value;
        if (id) {
            filiereData.id = parseInt(id);
        }
        
        console.log('üì§ Donn√©es √† envoyer:', filiereData);
        
        // Sauvegarder via l'API
        await apiClient.saveFiliere(filiereData);
        
        console.log('‚úÖ Fili√®re sauvegard√©e avec succ√®s');
        
        // Fermer le modal et recharger la liste
        closeModal('ajoutFiliereModal');
        await chargerFilieres();
        
        UIHelpers.showSuccess(`Fili√®re ${id ? 'modifi√©e' : 'ajout√©e'} avec succ√®s`);
        
    } catch (error) {
        console.error('‚ùå Erreur sauvegarde fili√®re:', error);
        UIHelpers.showError(error.message || 'Erreur lors de la sauvegarde');
    } finally {
        UIHelpers.showLoading(false);
    }
}
</script>
</body>
</html>