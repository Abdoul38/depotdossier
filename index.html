<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universite Djibo Hamani - D√©p√¥t de Dossiers en Ligne</title>
    
   
<link rel="stylesheet" href="Style.css">
<link rel="stylesheet" href="Style.css">

<script>
// CORRECTION PRINCIPALE - Ajouter ces fonctions au d√©but de votre script


// Fonction pour s'assurer que Chart.js est charg√©
function waitForChartJS(callback) {
    if (typeof Chart !== 'undefined') {
        callback();
    } else {
        console.log('En attente de Chart.js...');
        setTimeout(() => waitForChartJS(callback), 500);
    }
}

// Initialisation des statistiques corrig√©e
function initialiserStatistiques() {
    console.log('Initialisation du module statistiques');
    
    waitForChartJS(() => {
        console.log('Chart.js disponible, configuration...');
        
        // Configuration globale de Chart.js
        Chart.defaults.font.family = 'Arial, sans-serif';
        Chart.defaults.color = '#666';
        Chart.defaults.plugins.legend.labels.padding = 15;
        
        console.log('Module statistiques initialis√© avec succ√®s');
    });
}

// Fonction de d√©bogage pour v√©rifier les √©l√©ments
function verifierElementsStats() {
    const elements = [
        'statTotalCandidatures',
        'statApprouvees', 
        'statHommes',
        'statFemmes',
        'chartTopFilieres',
        'chartRepartitionBac',
        'chartEvolution',
        'chartGenre'
    ];
    
    console.log('=== V√âRIFICATION DES √âL√âMENTS STATISTIQUES ===');
    elements.forEach(id => {
        const element = document.getElementById(id);
        console.log(`${id}:`, element ? 'TROUV√â' : 'MANQUANT');
    });
    console.log('=== FIN V√âRIFICATION ===');
}

// Fonction de test pour v√©rifier ApiClient
function testerApiClient() {
    console.log('=== TEST APICLIENT ===');
    console.log('ApiClient d√©fini:', typeof apiClient !== 'undefined');
    console.log('Token pr√©sent:', apiClient?.token ? 'OUI' : 'NON');
    console.log('M√©thodes stats disponibles:');
    console.log('- getStatsDashboard:', typeof apiClient?.getStatsDashboard === 'function');
    console.log('- getStatsByGenre:', typeof apiClient?.getStatsByGenre === 'function');
    console.log('=== FIN TEST ===');
}

// Fonction de test compl√®te des statistiques
async function testerStatistiques() {
    console.log('üîç D√âBUT TEST COMPLET STATISTIQUES');
    
    try {
        // 1. V√©rifier les √©l√©ments HTML
        verifierElementsStats();
        
        // 2. V√©rifier ApiClient
        testerApiClient();
        
        // 3. Test d'une requ√™te simple
        if (typeof apiClient !== 'undefined' && apiClient.token) {
            console.log('üìä Test requ√™te dashboard...');
            const response = await apiClient.getStatsDashboard();
            console.log('‚úÖ R√©ponse re√ßue:', response);
        } else {
            console.log('‚ö†Ô∏è Impossible de tester - ApiClient non pr√™t');
        }
        
    } catch (error) {
        console.error('‚ùå Erreur test:', error);
    }
    
    console.log('üèÅ FIN TEST STATISTIQUES');
}

// AJOUTER CES FONCTIONS DE DIAGNOSTIC
window.debugStats = {
    verifierElements: verifierElementsStats,
    testerApi: testerApiClient,
    testerComplete: testerStatistiques,
    chargerDashboard: () => {
        if (typeof chargerTableauBordStats !== 'undefined') {
            chargerTableauBordStats();
        } else {
            console.error('Fonction chargerTableauBordStats non trouv√©e');
        }
    }
};

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initialisation page...');
    
    setTimeout(() => {
        initialiserStatistiques();
        
        // Test automatique si en mode admin
        if (localStorage.getItem('userRole') === 'admin') {
            console.log('üëë Mode admin d√©tect√© - test des statistiques');
            setTimeout(testerStatistiques, 3000);
        }
    }, 1000);
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
window.addEventListener('DOMContentLoaded', function() {
    if (typeof window.jspdf !== 'undefined' && window.jspdf.jsPDF) {
        window.jsPDF = window.jspdf.jsPDF;
        console.log('‚úÖ jsPDF charg√© avec succ√®s');
    } else {
        console.error('‚ùå Erreur de chargement de jsPDF');
    }
});
</script>
</head>
<body>
    
<div class="container">
        <header>
          <header class="header">
        <div class="logo-section">
            <img src="/uploads/logo-universite.png" alt="Logo Universit√©" class="logo-image" onerror="this.style.display='none'">
            <div class="logo-text">Universit√© Djibo Hamani de Tahoua</div>
        </div>
        <nav class="nav-buttons">
            <button class="btn btn-secondary" onclick="showPage('accueil')" id="homeBtn">Accueil</button>
            <button class="btn btn-secondary" onclick="showPage('connexion')" id="loginBtn">Connexion</button>
            
            <button class="btn btn-primary" onclick="showPage('inscription')" id="registerBtn">Creer compte</button>
            <button class="btn btn-primary" id="registerBtn">
                <a href="inscription.html" style="color: white; text-decoration: none;">Inscription</a>
            </button>
            <button class="btn btn-secondary" onclick="logout()" id="logoutBtn" style="display: none;">D√©connexion</button>
        </nav>
    </header>
        </header>
        
        <main class="main-content">
            <!-- Page d'accueil -->
            <div id="accueil" class="page active">
                <h1 style="text-align: center; margin-bottom: 30px; color: #333;">Bienvenue √† L'Universit√© Djibo Hamani de Tahoua</h1>
                <p style="text-align: center; font-size: 18px; margin-bottom: 40px; color: #666;">
                    Plateforme moderne de d√©p√¥t de dossiers en ligne pour les √©tablissements d'enseignement
                </p>
                
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-icon">üìã</div>
                        <div class="card-title">Processus Simplifi√©</div>
                        <div class="card-description">
                            D√©posez votre dossier en 4 √©tapes simples : informations personnelles, choix de fili√®re, documents et validation.
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-icon">üîí</div>
                        <div class="card-title">S√©curis√©</div>
                        <div class="card-description">
                            Vos donn√©es sont prot√©g√©es par des syst√®mes de s√©curit√© avanc√©s et un chiffrement de bout en bout.
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-icon">‚ö°</div>
                        <div class="card-title">Rapide</div>
                        <div class="card-description">
                            Suivi en temps r√©el de votre dossier avec notifications automatiques et t√©l√©chargement du quitus.
                        </div>
                    </div>
                </div>
            </div>
            <!-- Conteneur pour user.html -->
            <div id="user-content"></div>
            
            <!-- Conteneur pour admin.html -->
            <div id="admin-content"></div>
            
            <!-- Conteneur pour models.html -->
            <div id="models-content"></div>
        </main>
        
        <footer>
            <!-- Votre footer existant -->
        </footer>
    </div>


            <script src="apiClient.js"></script>
            <script src="inscription.js"></script>
            <script src="stat.js"></script>
            <script src="formation.js"></script>

    <script>
// Fonction pour charger un fichier HTML externe
async function includeHTML(file, containerId) {
    try {
        const response = await fetch(file);
        
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        
        const html = await response.text();
        document.getElementById(containerId).innerHTML = html;
        
        console.log(`‚úì ${file} charg√© avec succ√®s`);
        return true;
    } catch (error) {
        console.error(`Erreur lors du chargement de ${file}:`, error);
        document.getElementById(containerId).innerHTML = 
            `<p style="color: red;">Erreur de chargement: ${file}</p>`;
        return false;
    }
}

// Variable pour suivre si les fichiers sont charg√©s
let filesLoaded = false;

// Charger tous les fichiers et initialiser l'application
async function initializeApp() {
    if (filesLoaded) return;
    
    console.log('üöÄ Chargement des pages...');
    
    try {
        // Charger tous les fichiers en parall√®le
        await Promise.all([
            includeHTML('user.html', 'user-content'),
            includeHTML('admin.html', 'admin-content'),
            includeHTML('models.html', 'models-content')
        ]);
        
        filesLoaded = true;
        console.log('‚úÖ Toutes les pages charg√©es');
        
        // Initialiser l'application apr√®s le chargement
        initAfterLoad();
        
    } catch (error) {
        console.error('‚ùå Erreur lors du chargement des pages:', error);
    }
}

// Fonction d'initialisation apr√®s chargement des fichiers
function initAfterLoad() {
    // V√©rifier si l'utilisateur est connect√©
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('userRole');
    
    console.log('Token:', token ? 'Pr√©sent' : 'Absent');
    console.log('R√¥le:', role);
    
    if (token) {
        // Utilisateur connect√©
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('registerBtn').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'block';
        
        // Rediriger vers la bonne page selon le r√¥le
        if (role === 'admin') {
            showPage('adminPanel');
        } else {
            showPage('dashboard');
        }
    } else {
        // Utilisateur non connect√©
        document.getElementById('loginBtn').style.display = 'block';
        document.getElementById('registerBtn').style.display = 'block';
        document.getElementById('logoutBtn').style.display = 'none';
        showPage('accueil');
    }
}

// Charger au d√©marrage - UN SEUL √©v√©nement DOMContentLoaded
window.addEventListener('DOMContentLoaded', function() {
    console.log('üìÑ DOM charg√©');
    
    // Charger les pages HTML d'abord
    initializeApp();
    
    // Initialiser les statistiques apr√®s un d√©lai
    setTimeout(() => {
        if (typeof initialiserStatistiques === 'function') {
            initialiserStatistiques();
        }
    }, 1000);
});


</script>
    
    <script>


// Fonction pour t√©l√©charger un document sp√©cifique
async function telechargerDocument(applicationId, documentType) {
    try {
        UIHelpers.showLoading(true);
        await apiClient.downloadDocument(applicationId, documentType);
        UIHelpers.showSuccess('Document t√©l√©charg√© avec succ√®s');
    } catch (error) {
        console.error('Erreur t√©l√©chargement document:', error);
        UIHelpers.showError('Erreur lors du t√©l√©chargement du document');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Fonction pour t√©l√©charger le quitus depuis les d√©tails
async function telechargerQuitusDepuisDetails(applicationId) {
    try {
        UIHelpers.showLoading(true);
        
        // R√©cup√©rer les donn√©es du dossier
        const response = await apiClient.getApplication(applicationId);
        const application = response.application;
        
        // G√©n√©rer le quitus avec les donn√©es
        await genererQuitusAvecDonnees(application);
        
    } catch (error) {
        console.error('Erreur t√©l√©chargement quitus:', error);
        UIHelpers.showError('Erreur lors du t√©l√©chargement du quitus');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Fonction pour fermer le modal
function fermerModalDetails() {
    const overlay = document.getElementById('detailsModalOverlay');
    if (overlay) {
        overlay.remove();
    }
}
// Variables globales


// Mise √† jour de la navigation admin
function showAdminSection(section) {
    if (section === 'gestionFormations') {
        showPage('gestionFormations');
        // Ouvrir l'onglet facult√©s par d√©faut
        setTimeout(() => openFormationTab('facultes'), 100);
    } else {
        showPage(section);
    }
}



</script>

<script>
// Fonction pour ajouter un √©tudiant manuellement
async function ajouterEtudiantManuel(event) {
    event.preventDefault();
    
    try {
        UIHelpers.showLoading(true);
        
        const data = {
            numero_dossier: document.getElementById('addNumeroDossier').value.trim(),
            matricule: document.getElementById('addMatricule').value.trim() || null,
            nom: document.getElementById('addNom').value.trim(),
            prenom: document.getElementById('addPrenom').value.trim(),
            date_naissance: document.getElementById('addDateNaissance').value,
            lieu_naissance: document.getElementById('addLieuNaissance').value.trim(),
            nationalite: document.getElementById('addNationalite').value.trim(),
            genre: document.getElementById('addGenre').value,
            adresse: document.getElementById('addAdresse').value.trim(),
            telephone: document.getElementById('addTelephone').value.trim(),
            email: document.getElementById('addEmail').value.trim(),
            type_bac: document.getElementById('addTypeBac').value || null,
            lieu_obtention: document.getElementById('addLieuObtention').value.trim() || null,
            annee_obtention: document.getElementById('addAnneeObtention').value.trim() || null,
            mention: document.getElementById('addMention').value || null,
            statut: document.getElementById('addStatut').value,
            peut_inscrire: document.getElementById('addPeutInscrire').checked
        };
        
        // Appel API pour cr√©er l'√©tudiant
        const response = await apiClient.request('/admin/etudiants/creer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        closeModal('ajoutEtudiantModal');
        rechercherEtudiants();
        UIHelpers.showSuccess('√âtudiant ajout√© avec succ√®s');
        
        // R√©initialiser le formulaire
        document.getElementById('ajoutEtudiantManuelForm').reset();
        
    } catch (error) {
        console.error('Erreur ajout √©tudiant:', error);
        UIHelpers.showError(error.message || 'Erreur lors de l\'ajout');
    } finally {
        UIHelpers.showLoading(false);
    }
}

// Charger les types de bac pour le formulaire
async function chargerTypesBacPourAjout() {
    try {
        const response = await apiClient.getTypeBacs();
        const select = document.getElementById('addTypeBac');
        
        select.innerHTML = '<option value="">Aucun</option>';
        
        if (response.typeBacs) {
            response.typeBacs.forEach(type => {
                const option = document.createElement('option');
                option.value = type.nom;
                option.textContent = `${type.nom} - ${type.libelle}`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Erreur chargement types de bac:', error);
    }
}

// Ouvrir le modal d'ajout
function ouvrirModalAjoutEtudiant() {
    chargerTypesBacPourAjout();
    openModal('ajoutEtudiantModal');
}
</script>
<!-- Modal Inscription Admin -->
<!-- Modal Inscription Admin - VERSION SIMPLIFI√âE -->

</body>
</html>